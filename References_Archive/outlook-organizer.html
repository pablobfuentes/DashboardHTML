<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Outlook Inbox Organizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .language-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-direction: column;
        }

        .lang-label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
        }

        .toggle-switch input[type="checkbox"] {
            display: none;
        }

        .toggle-labels {
            display: flex;
            justify-content: space-between;
            width: 60px;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: bold;
            color: #555;
        }

        .toggle-label-text {
            transition: all 0.3s ease;
        }

        .toggle-switch input[type="checkbox"]:not(:checked) + .toggle-container .toggle-labels .en-label {
            color: #667eea;
            transform: scale(1.1);
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-container .toggle-labels .es-label {
            color: #667eea;
            transform: scale(1.1);
        }

        .toggle-label {
            display: block;
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle-label::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-container .toggle-label::after {
            transform: translateX(30px);
        }

        .connect-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .connect-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .connect-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .import-btn-wrapper {
            display: flex;
            align-items: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .gear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gear-btn:hover {
            transform: translateY(-2px) rotate(15deg);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.6);
            background: #5a6268;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            background: #f8d7da;
            color: #721c24;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            min-height: 500px;
        }

        .hidden {
            display: none;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 500;
            color: #555;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .email-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .email-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .email-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .email-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .email-subject {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .email-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .project-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
        }

        .project-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .project-tag.editing {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #667eea;
        }

        .project-editor {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 250px;
            padding: 15px;
            margin-top: 5px;
        }

        .project-editor.active {
            display: block;
        }

        .project-editor input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 12px;
        }

	.project-editor .input-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            display: block;
        }

        .project-editor .existing-projects {
            margin-bottom: 12px;
        }

        .project-editor .existing-projects-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
            display: block;
        }

        .project-editor .project-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .project-editor .project-btn {
            padding: 3px 8px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: #f8f9fa;
            color: #495057;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-editor .project-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .project-editor .control-buttons {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .project-editor button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-editor .save-btn {
            background: #28a745;
            color: white;
        }

        .project-editor .save-btn:hover {
            background: #218838;
        }

        .project-editor .cancel-btn {
            background: #6c757d;
            color: white;
        }

	.project-editor .cancel-btn:hover {
            background: #5a6268;
        }

        .attachments-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .attachments-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .attachments-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .attachments-table tr:hover {
            background: #f8f9fa;
        }

        .attachment-name {
            font-weight: 500;
            color: #333;
        }

        .attachment-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .attachment-link:hover {
            text-decoration: underline;
        }

        .file-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .summary {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .actions {
            margin-top: 15px;
        }

        .action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #ffc107;
        }

        .action-item.my-action {
            background: #ffe6e6;
            border-left-color: #dc3545;
        }

        .action-text {
            flex: 1;
            font-size: 13px;
        }

        .action-meta {
            font-size: 11px;
            color: #666;
            text-align: right;
        }
    .project-overall-summary {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .project-overall-summary h3 {
        color: #555;
        margin-bottom: 15px;
        font-size: 1.5rem;
    }

    .project-overall-summary p {
        margin-bottom: 8px;
        line-height: 1.5;
        color: #333;
    }

    .project-overall-summary ul {
        list-style-type: disc;
        margin-left: 20px;
        margin-bottom: 10px;
        color: #333;
    }

    .timeline-date-time {
        font-size: smaller;
        font-style: italic;
        color: #888;
        margin-bottom: 10px; /* Space between date and content columns */
    }

    .timeline-cols {
        display: flex;
        gap: 20px; /* Space between columns */
    }

    .timeline-col-left {
        flex: 3; /* Takes more space */
        min-width: 0; /* Allows content to shrink */
        word-wrap: break-word; /* Ensures long words wrap */
    }

    .timeline-col-right {
        flex: 2; /* Takes less space */
        min-width: 0; /* Allows content to shrink */
        word-wrap: break-word; /* Ensures long words wrap */
        border-left: 1px solid #eee; /* Visual separation */
        padding-left: 20px;
    }

    .timeline-actions-list {
        list-style-type: none; /* No bullets */
        padding-left: 0;
        margin-top: 5px;
    }

    .timeline-actions-list li {
        margin-bottom: 5px;
        padding: 5px;
        background: #f8f9fa; /* Light background for each action */
        border-radius: 5px;
        border-left: 3px solid #667eea; /* Accent border */
    }
        .timeline {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 25px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: -15px;
            width: 2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin: 15px 15px 0 15px;
            z-index: 1;
            position: relative;
        }

        .timeline-content {
        flex: 1;
        background: white;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex; /* Make it a flex container */
        flex-direction: column; /* Stack date and then columns */
    }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .timeline-date {
            font-size: 12px;
            color: #666;
        }

        .checklist {
            max-height: 600px;
            overflow-y: auto;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #e0e0e0;
        }

        .checklist-item.priority-high {
            border-left-color: #dc3545;
        }

        .checklist-item.priority-medium {
            border-left-color: #ffc107;
        }

        .checklist-item.priority-low {
            border-left-color: #28a745;
        }

        .checklist-item:hover {
            transform: translateX(5px);
        }

        .checklist-item.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .checklist-checkbox {
            margin-right: 15px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .checklist-content {
            flex: 1;
        }

        .checklist-task {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .checklist-meta {
            font-size: 12px;
            color: #666;
        }

        .priority-selector {
            margin: 0 10px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            cursor: pointer;
        }

        .priority-high {
            color: #dc3545;
            font-weight: 600;
        }

        .priority-medium {
            color: #ffc107;
            font-weight: 600;
        }

        .priority-low {
            color: #28a745;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 18px;
            color: #666;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Filter Modal Styles */
        .filter-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .filter-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .filter-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .filter-modal-header h2 {
            color: #333;
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            color: #999;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: #333;
            background: #f0f0f0;
        }

        .filter-add-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .filter-add-section h3 {
            margin: 0 0 15px 0;
            color: #555;
            font-size: 1.1rem;
        }

        .filter-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-filter-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .add-filter-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .filter-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .filter-list h3 {
            margin: 0 0 15px 0;
            color: #555;
            font-size: 1.1rem;
        }

        .filter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .filter-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(3px);
        }

        .filter-text {
            flex: 1;
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 13px;
            border: 1px solid #e9ecef;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
        }

        .edit-filter-btn, .delete-filter-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .edit-filter-btn {
            background: #ffc107;
            color: #212529;
        }

        .edit-filter-btn:hover {
            background: #e0a800;
        }

        .delete-filter-btn {
            background: #dc3545;
            color: white;
        }

        .delete-filter-btn:hover {
            background: #c82333;
        }

        .filter-stats {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #495057;
        }

        .no-filters-message {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            font-style: italic;
        }

        .import-drop-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .import-drop-btn.drag-over {
            background: linear-gradient(135deg, #28a745, #20c997);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.6);
        }

        .import-drop-btn::after {
            content: "Click or drag .msg files here";
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .import-drop-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            height: 600px;
        }

        .kanban-column {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .kanban-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .kanban-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .kanban-count {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .kanban-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .kanban-content::-webkit-scrollbar {
            width: 6px;
        }

        .kanban-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .kanban-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .kanban-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .kanban-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: move;
            transition: all 0.3s ease;
            border-left: 4px solid #e0e0e0;
        }

        .kanban-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .kanban-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .kanban-item.priority-high {
            border-left-color: #dc3545;
        }

        .kanban-item.priority-medium {
            border-left-color: #ffc107;
        }

        .kanban-item.priority-low {
            border-left-color: #28a745;
        }

        .kanban-column.drag-over {
            background: rgba(102, 126, 234, 0.1);
            border: 2px dashed #667eea;
        }

        .kanban-task-text {
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .kanban-task-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .kanban-task-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }

        .kanban-priority {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 11px;
            background: white;
            cursor: pointer;
        }

        .kanban-comments {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .kanban-comments-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .kanban-comments-textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            background: #fafafa;
            transition: all 0.2s ease;
        }

        .kanban-comments-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .kanban-comments-textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        /* Completed action styling for Dashboard and Timeline */
        .action-item.completed .action-text,
        .timeline-actions-list li.completed {
            text-decoration: line-through !important;
            opacity: 0.6 !important;
            color: #666 !important;
            background-color: #f8f9fa !important;
        }

        .action-item.completed .action-meta {
            opacity: 0.6 !important;
            color: #666 !important;
        }

        .action-item.completed {
            border-left-color: #6c757d !important;
        }

        /* ########## NEW LOADER STYLES ########## */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }

        .loader-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            max-width: 500px;
        }

        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 20px auto;
        }

        .loader-text {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }

        .loader-subtext {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            min-height: 20px; /* Reserve space to prevent layout shifts */
        }
        /* ########## END NEW LOADER STYLES ########## */

        /* Search bar styling */
        .search-group {
            display: flex;
            flex-direction: column;
            margin-left: auto;
        }

        .search-input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            width: 250px;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input::placeholder {
            color: #999;
            font-style: italic;
        }

        .filters {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 30px;
        }

        .pending-column .kanban-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            padding: 10px;
            border-bottom: none;
        }

        .progress-column .kanban-header {
            background: linear-gradient(135deg, #ffc107, #ff8c00);
            color: white;
            border-radius: 8px;
            padding: 10px;
            border-bottom: none;
        }

        .completed-column .kanban-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 8px;
            padding: 10px;
            border-bottom: none;
        }

        .pending-column .kanban-count,
        .progress-column .kanban-count,
        .completed-column .kanban-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
    </style>
<!--###############################################################################___END CSS BEGIN DATASTREAM__#############################-->
    <!-- Order matters: DataStream.js must be loaded before msgreader.js -->
	
<script>
/*
  DataStream reads scalars, arrays and structs of data from an ArrayBuffer.
  It's like a file-like DataView on steroids.

  @param {ArrayBuffer} arrayBuffer ArrayBuffer to read from.
  @param {?Number} byteOffset Offset from arrayBuffer beginning for the DataStream.
  @param {?Boolean} endianness DataStream.BIG_ENDIAN or DataStream.LITTLE_ENDIAN (the default).
*/
DataStream = function(arrayBuffer, byteOffset, endianness) {
  this._byteOffset = byteOffset || 0;
  if (arrayBuffer instanceof ArrayBuffer) {
    this.buffer = arrayBuffer;
  } else if (typeof arrayBuffer == "object") {
    this.dataView = arrayBuffer;
    if (byteOffset) {
      this._byteOffset += byteOffset;
    }
  } else {
    this.buffer = new ArrayBuffer(arrayBuffer || 1);
  }
  this.position = 0;
  this.endianness = endianness == null ? DataStream.LITTLE_ENDIAN : endianness;
};
DataStream.prototype = {};

/* Fix for Opera 12 not defining BYTES_PER_ELEMENT in typed array prototypes. */
if (Uint8Array.prototype.BYTES_PER_ELEMENT === undefined) {
    Uint8Array.prototype.BYTES_PER_ELEMENT = Uint8Array.BYTES_PER_ELEMENT; 
    Int8Array.prototype.BYTES_PER_ELEMENT = Int8Array.BYTES_PER_ELEMENT; 
    Uint8ClampedArray.prototype.BYTES_PER_ELEMENT = Uint8ClampedArray.BYTES_PER_ELEMENT; 
    Uint16Array.prototype.BYTES_PER_ELEMENT = Uint16Array.BYTES_PER_ELEMENT; 
    Int16Array.prototype.BYTES_PER_ELEMENT = Int16Array.BYTES_PER_ELEMENT; 
    Uint32Array.prototype.BYTES_PER_ELEMENT = Uint32Array.BYTES_PER_ELEMENT; 
    Int32Array.prototype.BYTES_PER_ELEMENT = Int32Array.BYTES_PER_ELEMENT; 
    Float64Array.prototype.BYTES_PER_ELEMENT = Float64Array.BYTES_PER_ELEMENT; 
}

/**
  Saves the DataStream contents to the given filename.
  Uses Chrome's anchor download property to initiate download.

  @param {string} filename Filename to save as.
  @return {null}
  */
DataStream.prototype.save = function(filename) {
  var blob = new Blob(this.buffer);
  var URL = (window.webkitURL || window.URL);
  if (URL && URL.createObjectURL) {
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.setAttribute('href', url);
      a.setAttribute('download', filename);
      a.click();
      URL.revokeObjectURL(url);
  } else {
      throw("DataStream.save: Can't create object URL.");
  }
};

/**
  Big-endian const to use as default endianness.
  @type {boolean}
  */
DataStream.BIG_ENDIAN = false;

/**
  Little-endian const to use as default endianness.
  @type {boolean}
  */
DataStream.LITTLE_ENDIAN = true;

/**
  Whether to extend DataStream buffer when trying to write beyond its size.
  If set, the buffer is reallocated to twice its current size until the
  requested write fits the buffer.
  @type {boolean}
  */
DataStream.prototype._dynamicSize = true;
Object.defineProperty(DataStream.prototype, 'dynamicSize',
  { get: function() {
      return this._dynamicSize;
    },
    set: function(v) {
      if (!v) {
        this._trimAlloc();
      }
      this._dynamicSize = v;
    } });

/**
  Virtual byte length of the DataStream backing buffer.
  Updated to be max of original buffer size and last written size.
  If dynamicSize is false is set to buffer size.
  @type {number}
  */
DataStream.prototype._byteLength = 0;

/**
  Returns the byte length of the DataStream object.
  @type {number}
  */
Object.defineProperty(DataStream.prototype, 'byteLength',
  { get: function() {
    return this._byteLength - this._byteOffset;
  }});

/**
  Set/get the backing ArrayBuffer of the DataStream object.
  The setter updates the DataView to point to the new buffer.
  @type {Object}
  */
Object.defineProperty(DataStream.prototype, 'buffer',
  { get: function() {
      this._trimAlloc();
      return this._buffer;
    },
    set: function(v) {
      this._buffer = v;
      this._dataView = new DataView(this._buffer, this._byteOffset);
      this._byteLength = this._buffer.byteLength;
    } });

/**
  Set/get the byteOffset of the DataStream object.
  The setter updates the DataView to point to the new byteOffset.
  @type {number}
  */
Object.defineProperty(DataStream.prototype, 'byteOffset',
  { get: function() {
      return this._byteOffset;
    },
    set: function(v) {
      this._byteOffset = v;
      this._dataView = new DataView(this._buffer, this._byteOffset);
      this._byteLength = this._buffer.byteLength;
    } });

/**
  Set/get the backing DataView of the DataStream object.
  The setter updates the buffer and byteOffset to point to the DataView values.
  @type {Object}
  */
Object.defineProperty(DataStream.prototype, 'dataView',
  { get: function() {
      return this._dataView;
    },
    set: function(v) {
      this._byteOffset = v.byteOffset;
      this._buffer = v.buffer;
      this._dataView = new DataView(this._buffer, this._byteOffset);
      this._byteLength = this._byteOffset + v.byteLength;
    } });

/**
  Internal function to resize the DataStream buffer when required.
  @param {number} extra Number of bytes to add to the buffer allocation.
  @return {null}
  */
DataStream.prototype._realloc = function(extra) {
  if (!this._dynamicSize) {
    return;
  }
  var req = this._byteOffset + this.position + extra;
  var blen = this._buffer.byteLength;
  if (req <= blen) {
    if (req > this._byteLength) {
      this._byteLength = req;
    }
    return;
  }
  if (blen < 1) {
    blen = 1;
  }
  while (req > blen) {
    blen *= 2;
  }
  var buf = new ArrayBuffer(blen);
  var src = new Uint8Array(this._buffer);
  var dst = new Uint8Array(buf, 0, src.length);
  dst.set(src);
  this.buffer = buf;
  this._byteLength = req;
};

/**
  Internal function to trim the DataStream buffer when required.
  Used for stripping out the extra bytes from the backing buffer when
  the virtual byteLength is smaller than the buffer byteLength (happens after
  growing the buffer with writes and not filling the extra space completely).

  @return {null}
  */
DataStream.prototype._trimAlloc = function() {
  if (this._byteLength == this._buffer.byteLength) {
    return;
  }
  var buf = new ArrayBuffer(this._byteLength);
  var dst = new Uint8Array(buf);
  var src = new Uint8Array(this._buffer, 0, dst.length);
  dst.set(src);
  this.buffer = buf;
};

/**
  Sets the DataStream read/write position to given position.
  Clamps between 0 and DataStream length.

  @param {number} pos Position to seek to.
  @return {null}
  */
DataStream.prototype.seek = function(pos) {
  var npos = Math.max(0, Math.min(this.byteLength, pos));
  this.position = (isNaN(npos) || !isFinite(npos)) ? 0 : npos;
};

/**
  Returns true if the DataStream seek pointer is at the end of buffer and
  there's no more data to read.

  @return {boolean} True if the seek pointer is at the end of the buffer.
  */
DataStream.prototype.isEof = function() {
  return (this.position >= this.byteLength);
};

/**
  Maps an Int32Array into the DataStream buffer, swizzling it to native
  endianness in-place. The current offset from the start of the buffer needs to
  be a multiple of element size, just like with typed array views.

  Nice for quickly reading in data. Warning: potentially modifies the buffer
  contents.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Int32Array to the DataStream backing buffer.
  */
DataStream.prototype.mapInt32Array = function(length, e) {
  this._realloc(length * 4);
  var arr = new Int32Array(this._buffer, this.byteOffset+this.position, length);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += length * 4;
  return arr;
};

/**
  Maps an Int16Array into the DataStream buffer, swizzling it to native
  endianness in-place. The current offset from the start of the buffer needs to
  be a multiple of element size, just like with typed array views.

  Nice for quickly reading in data. Warning: potentially modifies the buffer
  contents.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Int16Array to the DataStream backing buffer.
  */
DataStream.prototype.mapInt16Array = function(length, e) {
  this._realloc(length * 2);
  var arr = new Int16Array(this._buffer, this.byteOffset+this.position, length);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += length * 2;
  return arr;
};

/**
  Maps an Int8Array into the DataStream buffer.

  Nice for quickly reading in data.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Int8Array to the DataStream backing buffer.
  */
DataStream.prototype.mapInt8Array = function(length) {
  this._realloc(length * 1);
  var arr = new Int8Array(this._buffer, this.byteOffset+this.position, length);
  this.position += length * 1;
  return arr;
};

/**
  Maps a Uint32Array into the DataStream buffer, swizzling it to native
  endianness in-place. The current offset from the start of the buffer needs to
  be a multiple of element size, just like with typed array views.

  Nice for quickly reading in data. Warning: potentially modifies the buffer
  contents.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Uint32Array to the DataStream backing buffer.
  */
DataStream.prototype.mapUint32Array = function(length, e) {
  this._realloc(length * 4);
  var arr = new Uint32Array(this._buffer, this.byteOffset+this.position, length);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += length * 4;
  return arr;
};

/**
  Maps a Uint16Array into the DataStream buffer, swizzling it to native
  endianness in-place. The current offset from the start of the buffer needs to
  be a multiple of element size, just like with typed array views.

  Nice for quickly reading in data. Warning: potentially modifies the buffer
  contents.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Uint16Array to the DataStream backing buffer.
  */
DataStream.prototype.mapUint16Array = function(length, e) {
  this._realloc(length * 2);
  var arr = new Uint16Array(this._buffer, this.byteOffset+this.position, length);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += length * 2;
  return arr;
};

/**
  Maps a Uint8Array into the DataStream buffer.

  Nice for quickly reading in data.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Uint8Array to the DataStream backing buffer.
  */
DataStream.prototype.mapUint8Array = function(length) {
  this._realloc(length * 1);
  var arr = new Uint8Array(this._buffer, this.byteOffset+this.position, length);
  this.position += length * 1;
  return arr;
};

/**
  Maps a Float64Array into the DataStream buffer, swizzling it to native
  endianness in-place. The current offset from the start of the buffer needs to
  be a multiple of element size, just like with typed array views.

  Nice for quickly reading in data. Warning: potentially modifies the buffer
  contents.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Float64Array to the DataStream backing buffer.
  */
DataStream.prototype.mapFloat64Array = function(length, e) {
  this._realloc(length * 8);
  var arr = new Float64Array(this._buffer, this.byteOffset+this.position, length);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += length * 8;
  return arr;
};

/**
  Maps a Float32Array into the DataStream buffer, swizzling it to native
  endianness in-place. The current offset from the start of the buffer needs to
  be a multiple of element size, just like with typed array views.

  Nice for quickly reading in data. Warning: potentially modifies the buffer
  contents.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} Float32Array to the DataStream backing buffer.
  */
DataStream.prototype.mapFloat32Array = function(length, e) {
  this._realloc(length * 4);
  var arr = new Float32Array(this._buffer, this.byteOffset+this.position, length);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += length * 4;
  return arr;
};

/**
  Reads an Int32Array of desired length and endianness from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Int32Array.
 */
DataStream.prototype.readInt32Array = function(length, e) {
  length = length == null ? (this.byteLength-this.position / 4) : length;
  var arr = new Int32Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += arr.byteLength;
  return arr;
};

/**
  Reads an Int16Array of desired length and endianness from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Int16Array.
 */
DataStream.prototype.readInt16Array = function(length, e) {
  length = length == null ? (this.byteLength-this.position / 2) : length;
  var arr = new Int16Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += arr.byteLength;
  return arr;
};

/**
  Reads an Int8Array of desired length from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Int8Array.
 */
DataStream.prototype.readInt8Array = function(length) {
  length = length == null ? (this.byteLength-this.position) : length;
  var arr = new Int8Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  this.position += arr.byteLength;
  return arr;
};

/**
  Reads a Uint32Array of desired length and endianness from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Uint32Array.
 */
DataStream.prototype.readUint32Array = function(length, e) {
  length = length == null ? (this.byteLength-this.position / 4) : length;
  var arr = new Uint32Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += arr.byteLength;
  return arr;
};

/**
  Reads a Uint16Array of desired length and endianness from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Uint16Array.
 */
DataStream.prototype.readUint16Array = function(length, e) {
  length = length == null ? (this.byteLength-this.position / 2) : length;
  var arr = new Uint16Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += arr.byteLength;
  return arr;
};

/**
  Reads a Uint8Array of desired length from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Uint8Array.
 */
DataStream.prototype.readUint8Array = function(length) {
  length = length == null ? (this.byteLength-this.position) : length;
  var arr = new Uint8Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  this.position += arr.byteLength;
  return arr;
};

/**
  Reads a Float64Array of desired length and endianness from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Float64Array.
 */
DataStream.prototype.readFloat64Array = function(length, e) {
  length = length == null ? (this.byteLength-this.position / 8) : length;
  var arr = new Float64Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += arr.byteLength;
  return arr;
};

/**
  Reads a Float32Array of desired length and endianness from the DataStream.

  @param {number} length Number of elements to map.
  @param {?boolean} e Endianness of the data to read.
  @return {Object} The read Float32Array.
 */
DataStream.prototype.readFloat32Array = function(length, e) {
  length = length == null ? (this.byteLength-this.position / 4) : length;
  var arr = new Float32Array(length);
  DataStream.memcpy(arr.buffer, 0,
                    this.buffer, this.byteOffset+this.position,
                    length*arr.BYTES_PER_ELEMENT);
  DataStream.arrayToNative(arr, e == null ? this.endianness : e);
  this.position += arr.byteLength;
  return arr;
};

/**
  Writes an Int32Array of specified endianness to the DataStream.

  @param {Object} arr The array to write.
  @param {?boolean} e Endianness of the data to write.
 */
DataStream.prototype.writeInt32Array = function(arr, e) {
  this._realloc(arr.length * 4);
  if (arr instanceof Int32Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapInt32Array(arr.length, e);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeInt32(arr[i], e);
    }
  }
};

/**
  Writes an Int16Array of specified endianness to the DataStream.

  @param {Object} arr The array to write.
  @param {?boolean} e Endianness of the data to write.
 */
DataStream.prototype.writeInt16Array = function(arr, e) {
  this._realloc(arr.length * 2);
  if (arr instanceof Int16Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapInt16Array(arr.length, e);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeInt16(arr[i], e);
    }
  }
};

/**
  Writes an Int8Array to the DataStream.

  @param {Object} arr The array to write.
 */
DataStream.prototype.writeInt8Array = function(arr) {
  this._realloc(arr.length * 1);
  if (arr instanceof Int8Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapInt8Array(arr.length);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeInt8(arr[i]);
    }
  }
};

/**
  Writes a Uint32Array of specified endianness to the DataStream.

  @param {Object} arr The array to write.
  @param {?boolean} e Endianness of the data to write.
 */
DataStream.prototype.writeUint32Array = function(arr, e) {
  this._realloc(arr.length * 4);
  if (arr instanceof Uint32Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapUint32Array(arr.length, e);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeUint32(arr[i], e);
    }
  }
};

/**
  Writes a Uint16Array of specified endianness to the DataStream.

  @param {Object} arr The array to write.
  @param {?boolean} e Endianness of the data to write.
 */
DataStream.prototype.writeUint16Array = function(arr, e) {
  this._realloc(arr.length * 2);
  if (arr instanceof Uint16Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapUint16Array(arr.length, e);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeUint16(arr[i], e);
    }
  }
};

/**
  Writes a Uint8Array to the DataStream.

  @param {Object} arr The array to write.
 */
DataStream.prototype.writeUint8Array = function(arr) {
  this._realloc(arr.length * 1);
  if (arr instanceof Uint8Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapUint8Array(arr.length);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeUint8(arr[i]);
    }
  }
};

/**
  Writes a Float64Array of specified endianness to the DataStream.

  @param {Object} arr The array to write.
  @param {?boolean} e Endianness of the data to write.
 */
DataStream.prototype.writeFloat64Array = function(arr, e) {
  this._realloc(arr.length * 8);
  if (arr instanceof Float64Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapFloat64Array(arr.length, e);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeFloat64(arr[i], e);
    }
  }
};

/**
  Writes a Float32Array of specified endianness to the DataStream.

  @param {Object} arr The array to write.
  @param {?boolean} e Endianness of the data to write.
 */
DataStream.prototype.writeFloat32Array = function(arr, e) {
  this._realloc(arr.length * 4);
  if (arr instanceof Float32Array &&
      this.byteOffset+this.position % arr.BYTES_PER_ELEMENT == 0) {
    DataStream.memcpy(this._buffer, this.byteOffset+this.position,
                      arr.buffer, 0,
                      arr.byteLength);
    this.mapFloat32Array(arr.length, e);
  } else {
    for (var i=0; i<arr.length; i++) {
      this.writeFloat32(arr[i], e);
    }
  }
};


/**
  Reads a 32-bit int from the DataStream with the desired endianness.

  @param {?boolean} e Endianness of the number.
  @return {number} The read number.
 */
DataStream.prototype.readInt32 = function(e) {
  var v = this._dataView.getInt32(this.position, e == null ? this.endianness : e);
  this.position += 4;
  return v;
};

/**
 Reads a 32-bit int from the DataStream with the offset.

 @param {number} offset The offset.
 @return {number} The read number.
 */
DataStream.prototype.readInt = function (offset) {
  this.seek(offset);
  return this.readInt32();
};

/**
  Reads a 16-bit int from the DataStream with the desired endianness.

  @param {?boolean} e Endianness of the number.
  @return {number} The read number.
 */
DataStream.prototype.readInt16 = function(e) {
  var v = this._dataView.getInt16(this.position, e == null ? this.endianness : e);
  this.position += 2;
  return v;
};

/**
 Reads a 16-bit int from the DataStream with the offset

 @param {number} offset The offset.
 @return {number} The read number.
 */
DataStream.prototype.readShort = function (offset) {
  this.seek(offset);
  return this.readInt16();
};

/**
  Reads an 8-bit int from the DataStream.

  @return {number} The read number.
 */
DataStream.prototype.readInt8 = function() {
  var v = this._dataView.getInt8(this.position);
  this.position += 1;
  return v;
};

/**
 Reads an 8-bit int from the DataStream with the offset.

 @param {number} offset The offset.
 @return {number} The read number.
 */
DataStream.prototype.readByte = function (offset) {
  this.seek(offset);
  return this.readInt8();
};


/**
  Reads a 32-bit unsigned int from the DataStream with the desired endianness.

  @param {?boolean} e Endianness of the number.
  @return {number} The read number.
 */
DataStream.prototype.readUint32 = function(e) {
  var v = this._dataView.getUint32(this.position, e == null ? this.endianness : e);
  this.position += 4;
  return v;
};

/**
  Reads a 16-bit unsigned int from the DataStream with the desired endianness.

  @param {?boolean} e Endianness of the number.
  @return {number} The read number.
 */
DataStream.prototype.readUint16 = function(e) {
  var v = this._dataView.getUint16(this.position, e == null ? this.endianness : e);
  this.position += 2;
  return v;
};

/**
  Reads an 8-bit unsigned int from the DataStream.

  @return {number} The read number.
 */
DataStream.prototype.readUint8 = function() {
  var v = this._dataView.getUint8(this.position);
  this.position += 1;
  return v;
};

/**
  Reads a 32-bit float from the DataStream with the desired endianness.

  @param {?boolean} e Endianness of the number.
  @return {number} The read number.
 */
DataStream.prototype.readFloat32 = function(e) {
  var v = this._dataView.getFloat32(this.position, e == null ? this.endianness : e);
  this.position += 4;
  return v;
};

/**
  Reads a 64-bit float from the DataStream with the desired endianness.

  @param {?boolean} e Endianness of the number.
  @return {number} The read number.
 */
DataStream.prototype.readFloat64 = function(e) {
  var v = this._dataView.getFloat64(this.position, e == null ? this.endianness : e);
  this.position += 8;
  return v;
};


/**
  Writes a 32-bit int to the DataStream with the desired endianness.

  @param {number} v Number to write.
  @param {?boolean} e Endianness of the number.
 */
DataStream.prototype.writeInt32 = function(v, e) {
  this._realloc(4);
  this._dataView.setInt32(this.position, v, e == null ? this.endianness : e);
  this.position += 4;
};

/**
  Writes a 16-bit int to the DataStream with the desired endianness.

  @param {number} v Number to write.
  @param {?boolean} e Endianness of the number.
 */
DataStream.prototype.writeInt16 = function(v, e) {
  this._realloc(2);
  this._dataView.setInt16(this.position, v, e == null ? this.endianness : e);
  this.position += 2;
};

/**
  Writes an 8-bit int to the DataStream.

  @param {number} v Number to write.
 */
DataStream.prototype.writeInt8 = function(v) {
  this._realloc(1);
  this._dataView.setInt8(this.position, v);
  this.position += 1;
};

/**
  Writes a 32-bit unsigned int to the DataStream with the desired endianness.

  @param {number} v Number to write.
  @param {?boolean} e Endianness of the number.
 */
DataStream.prototype.writeUint32 = function(v, e) {
  this._realloc(4);
  this._dataView.setUint32(this.position, v, e == null ? this.endianness : e);
  this.position += 4;
};

/**
  Writes a 16-bit unsigned int to the DataStream with the desired endianness.

  @param {number} v Number to write.
  @param {?boolean} e Endianness of the number.
 */
DataStream.prototype.writeUint16 = function(v, e) {
  this._realloc(2);
  this._dataView.setUint16(this.position, v, e == null ? this.endianness : e);
  this.position += 2;
};

/**
  Writes an 8-bit unsigned  int to the DataStream.

  @param {number} v Number to write.
 */
DataStream.prototype.writeUint8 = function(v) {
  this._realloc(1);
  this._dataView.setUint8(this.position, v);
  this.position += 1;
};

/**
  Writes a 32-bit float to the DataStream with the desired endianness.

  @param {number} v Number to write.
  @param {?boolean} e Endianness of the number.
 */
DataStream.prototype.writeFloat32 = function(v, e) {
  this._realloc(4);
  this._dataView.setFloat32(this.position, v, e == null ? this.endianness : e);
  this.position += 4;
};

/**
  Writes a 64-bit float to the DataStream with the desired endianness.

  @param {number} v Number to write.
  @param {?boolean} e Endianness of the number.
 */
DataStream.prototype.writeFloat64 = function(v, e) {
  this._realloc(8);
  this._dataView.setFloat64(this.position, v, e == null ? this.endianness : e);
  this.position += 8;
};

/**
  Native endianness. Either DataStream.BIG_ENDIAN or DataStream.LITTLE_ENDIAN
  depending on the platform endianness.

  @type {boolean}
 */
DataStream.endianness = new Int8Array(new Int16Array([1]).buffer)[0] > 0;

/**
  Copies byteLength bytes from the src buffer at srcOffset to the
  dst buffer at dstOffset.

  @param {Object} dst Destination ArrayBuffer to write to.
  @param {number} dstOffset Offset to the destination ArrayBuffer.
  @param {Object} src Source ArrayBuffer to read from.
  @param {number} srcOffset Offset to the source ArrayBuffer.
  @param {number} byteLength Number of bytes to copy.
 */
DataStream.memcpy = function(dst, dstOffset, src, srcOffset, byteLength) {
  var dstU8 = new Uint8Array(dst, dstOffset, byteLength);
  var srcU8 = new Uint8Array(src, srcOffset, byteLength);
  dstU8.set(srcU8);
};

/**
  Converts array to native endianness in-place.

  @param {Object} array Typed array to convert.
  @param {boolean} arrayIsLittleEndian True if the data in the array is
                                       little-endian. Set false for big-endian.
  @return {Object} The converted typed array.
 */
DataStream.arrayToNative = function(array, arrayIsLittleEndian) {
  if (arrayIsLittleEndian == this.endianness) {
    return array;
  } else {
    return this.flipArrayEndianness(array);
  }
};

/**
  Converts native endianness array to desired endianness in-place.

  @param {Object} array Typed array to convert.
  @param {boolean} littleEndian True if the converted array should be
                                little-endian. Set false for big-endian.
  @return {Object} The converted typed array.
 */
DataStream.nativeToEndian = function(array, littleEndian) {
  if (this.endianness == littleEndian) {
    return array;
  } else {
    return this.flipArrayEndianness(array);
  }
};

/**
  Flips typed array endianness in-place.

  @param {Object} array Typed array to flip.
  @return {Object} The converted typed array.
 */
DataStream.flipArrayEndianness = function(array) {
  var u8 = new Uint8Array(array.buffer, array.byteOffset, array.byteLength);
  for (var i=0; i<array.byteLength; i+=array.BYTES_PER_ELEMENT) {
    for (var j=i+array.BYTES_PER_ELEMENT-1, k=i; j>k; j--, k++) {
      var tmp = u8[k];
      u8[k] = u8[j];
      u8[j] = tmp;
    }
  }
  return array;
};

/**
  Creates an array from an array of character codes.
  Uses String.fromCharCode on the character codes and concats the results into a string.

  @param {array} array Array of character codes.
  @return {string} String created from the character codes.
**/
DataStream.createStringFromArray = function(array) {
  var str = "";
  for (var i=0; i<array.length; i++) {
    str += String.fromCharCode(array[i]);
  }
  return str;
};

/**
  Seek position where DataStream#readStruct ran into a problem.
  Useful for debugging struct parsing.

  @type {number}
 */
DataStream.prototype.failurePosition = 0;

/**
  Reads a struct of data from the DataStream. The struct is defined as
  a flat array of [name, type]-pairs. See the example below:

  ds.readStruct([
    'headerTag', 'uint32', // Uint32 in DataStream endianness.
    'headerTag2', 'uint32be', // Big-endian Uint32.
    'headerTag3', 'uint32le', // Little-endian Uint32.
    'array', ['[]', 'uint32', 16], // Uint32Array of length 16.
    'array2Length', 'uint32',
    'array2', ['[]', 'uint32', 'array2Length'] // Uint32Array of length array2Length
  ]);

  The possible values for the type are as follows:

  // Number types

  // Unsuffixed number types use DataStream endianness.
  // To explicitly specify endianness, suffix the type with
  // 'le' for little-endian or 'be' for big-endian,
  // e.g. 'int32be' for big-endian int32.

  'uint8' -- 8-bit unsigned int
  'uint16' -- 16-bit unsigned int
  'uint32' -- 32-bit unsigned int
  'int8' -- 8-bit int
  'int16' -- 16-bit int
  'int32' -- 32-bit int
  'float32' -- 32-bit float
  'float64' -- 64-bit float

  // String types
  'cstring' -- ASCII string terminated by a zero byte.
  'string:N' -- ASCII string of length N, where N is a literal integer.
  'string:variableName' -- ASCII string of length $variableName,
    where 'variableName' is a previously parsed number in the current struct.
  'string,CHARSET:N' -- String of byteLength N encoded with given CHARSET.
  'u16string:N' -- UCS-2 string of length N in DataStream endianness.
  'u16stringle:N' -- UCS-2 string of length N in little-endian.
  'u16stringbe:N' -- UCS-2 string of length N in big-endian.

  // Complex types
  [name, type, name_2, type_2, ..., name_N, type_N] -- Struct
  function(dataStream, struct) {} -- Callback function to read and return data.
  {get: function(dataStream, struct) {},
   set: function(dataStream, struct) {}}
  -- Getter/setter functions to read and return data, handy for using the same
     struct definition for reading and writing structs.
  ['[]', type, length] -- Array of given type and length. The length can be either
                        a number, a string that references a previously-read
                        field, or a callback function(struct, dataStream, type){}.
                        If length is '*', reads in as many elements as it can.

  @param {Object} structDefinition Struct definition object.
  @return {Object} The read struct. Null if failed to read struct.
 */
DataStream.prototype.readStruct = function(structDefinition) {
  var struct = {}, t, v, n;
  var p = this.position;
  for (var i=0; i<structDefinition.length; i+=2) {
    t = structDefinition[i+1];
    v = this.readType(t, struct);
    if (v == null) {
      if (this.failurePosition == 0) {
        this.failurePosition = this.position;
      }
      this.position = p;
      return null;
    }
    struct[structDefinition[i]] = v;
  }
  return struct;
};

/**
  Read UCS-2 string of desired length and endianness from the DataStream.

  @param {number} length The length of the string to read.
  @param {boolean} endianness The endianness of the string data in the DataStream.
  @return {string} The read string.
 */
DataStream.prototype.readUCS2String = function(length, endianness) {
  return DataStream.createStringFromArray(this.readUint16Array(length, endianness));
};

/**
 Read UCS-2 string of desired length and offset from the DataStream.

 @param {number} offset The offset.
 @param {number} length The length of the string to read.
 @return {string} The read string.
 */
DataStream.prototype.readStringAt = function (offset, length) {
  this.seek(offset);
  return this.readUCS2String(length);
};

/**
  Write a UCS-2 string of desired endianness to the DataStream. The
  lengthOverride argument lets you define the number of characters to write.
  If the string is shorter than lengthOverride, the extra space is padded with
  zeroes.

  @param {string} str The string to write.
  @param {?boolean} endianness The endianness to use for the written string data.
  @param {?number} lengthOverride The number of characters to write.
 */
DataStream.prototype.writeUCS2String = function(str, endianness, lengthOverride) {
  if (lengthOverride == null) {
    lengthOverride = str.length;
  }
  for (var i = 0; i < str.length && i < lengthOverride; i++) {
    this.writeUint16(str.charCodeAt(i), endianness);
  }
  for (; i<lengthOverride; i++) {
    this.writeUint16(0);
  }
};

/**
  Read a string of desired length and encoding from the DataStream.

  @param {number} length The length of the string to read in bytes.
  @param {?string} encoding The encoding of the string data in the DataStream.
                            Defaults to ASCII.
  @return {string} The read string.
 */
DataStream.prototype.readString = function(length, encoding) {
  if (encoding == null || encoding == "ASCII") {
    return DataStream.createStringFromArray(this.mapUint8Array(length == null ? this.byteLength-this.position : length));
  } else {
    return (new TextDecoder(encoding)).decode(this.mapUint8Array(length));
  }
};

/**
  Writes a string of desired length and encoding to the DataStream.

  @param {string} s The string to write.
  @param {?string} encoding The encoding for the written string data.
                            Defaults to ASCII.
  @param {?number} length The number of characters to write.
 */
DataStream.prototype.writeString = function(s, encoding, length) {
  if (encoding == null || encoding == "ASCII") {
    if (length != null) {
      var i = 0;
      var len = Math.min(s.length, length);
      for (i=0; i<len; i++) {
        this.writeUint8(s.charCodeAt(i));
      }
      for (; i<length; i++) {
        this.writeUint8(0);
      }
    } else {
      for (var i=0; i<s.length; i++) {
        this.writeUint8(s.charCodeAt(i));
      }
    }
  } else {
    this.writeUint8Array((new TextEncoder(encoding)).encode(s.substring(0, length)));
  }
};


/**
  Read null-terminated string of desired length from the DataStream. Truncates
  the returned string so that the null byte is not a part of it.

  @param {?number} length The length of the string to read.
  @return {string} The read string.
 */
DataStream.prototype.readCString = function(length) {
  var blen = this.byteLength-this.position;
  var u8 = new Uint8Array(this._buffer, this._byteOffset + this.position);
  var len = blen;
  if (length != null) {
    len = Math.min(length, blen);
  }
  for (var i = 0; i < len && u8[i] != 0; i++); // find first zero byte
  var s = DataStream.createStringFromArray(this.mapUint8Array(i));
  if (length != null) {
    this.position += len-i;
  } else if (i != blen) {
    this.position += 1; // trailing zero if not at end of buffer
  }
  return s;
};

/**
  Writes a null-terminated string to DataStream and zero-pads it to length
  bytes. If length is not given, writes the string followed by a zero.
  If string is longer than length, the written part of the string does not have
  a trailing zero.

  @param {string} s The string to write.
  @param {?number} length The number of characters to write.
 */
DataStream.prototype.writeCString = function(s, length) {
  if (length != null) {
    var i = 0;
    var len = Math.min(s.length, length);
    for (i=0; i<len; i++) {
      this.writeUint8(s.charCodeAt(i));
    }
    for (; i<length; i++) {
      this.writeUint8(0);
    }
  } else {
    for (var i=0; i<s.length; i++) {
      this.writeUint8(s.charCodeAt(i));
    }
    this.writeUint8(0);
  }
};

/**
  Reads an object of type t from the DataStream, passing struct as the thus-far
  read struct to possible callbacks that refer to it. Used by readStruct for
  reading in the values, so the type is one of the readStruct types.

  @param {Object} t Type of the object to read.
  @param {?Object} struct Struct to refer to when resolving length references
                          and for calling callbacks.
  @return {?Object} Returns the object on successful read, null on unsuccessful.
 */
DataStream.prototype.readType = function(t, struct) {
  if (typeof t == "function") {
    return t(this, struct);
  } else if (typeof t == "object" && !(t instanceof Array)) {
    return t.get(this, struct);
  } else if (t instanceof Array && t.length != 3) {
    return this.readStruct(t, struct);
  }
  var v = null;
  var lengthOverride = null;
  var charset = "ASCII";
  var pos = this.position;
  var len;
  if (typeof t == 'string' && /:/.test(t)) {
    var tp = t.split(":");
    t = tp[0];
    len = tp[1];

    // allow length to be previously parsed variable
    // e.g. 'string:fieldLength', if `fieldLength` has
    // been parsed previously.
    if (struct[len] != null) {
      lengthOverride = parseInt(struct[len]);
    } else {
      // assume literal integer e.g., 'string:4'
      lengthOverride = parseInt(tp[1]);
    }
  }
  if (typeof t == 'string' && /,/.test(t)) {
    var tp = t.split(",");
    t = tp[0];
    charset = parseInt(tp[1]);
  }
  switch(t) {

    case 'uint8':
      v = this.readUint8(); break;
    case 'int8':
      v = this.readInt8(); break;

    case 'uint16':
      v = this.readUint16(this.endianness); break;
    case 'int16':
      v = this.readInt16(this.endianness); break;
    case 'uint32':
      v = this.readUint32(this.endianness); break;
    case 'int32':
      v = this.readInt32(this.endianness); break;
    case 'float32':
      v = this.readFloat32(this.endianness); break;
    case 'float64':
      v = this.readFloat64(this.endianness); break;

    case 'uint16be':
      v = this.readUint16(DataStream.BIG_ENDIAN); break;
    case 'int16be':
      v = this.readInt16(DataStream.BIG_ENDIAN); break;
    case 'uint32be':
      v = this.readUint32(DataStream.BIG_ENDIAN); break;
    case 'int32be':
      v = this.readInt32(DataStream.BIG_ENDIAN); break;
    case 'float32be':
      v = this.readFloat32(DataStream.BIG_ENDIAN); break;
    case 'float64be':
      v = this.readFloat64(DataStream.BIG_ENDIAN); break;

    case 'uint16le':
      v = this.readUint16(DataStream.LITTLE_ENDIAN); break;
    case 'int16le':
      v = this.readInt16(DataStream.LITTLE_ENDIAN); break;
    case 'uint32le':
      v = this.readUint32(DataStream.LITTLE_ENDIAN); break;
    case 'int32le':
      v = this.readInt32(DataStream.LITTLE_ENDIAN); break;
    case 'float32le':
      v = this.readFloat32(DataStream.LITTLE_ENDIAN); break;
    case 'float64le':
      v = this.readFloat64(DataStream.LITTLE_ENDIAN); break;

    case 'cstring':
      v = this.readCString(lengthOverride); break;

    case 'string':
      v = this.readString(lengthOverride, charset); break;

    case 'u16string':
      v = this.readUCS2String(lengthOverride, this.endianness); break;

    case 'u16stringle':
      v = this.readUCS2String(lengthOverride, DataStream.LITTLE_ENDIAN); break;

    case 'u16stringbe':
      v = this.readUCS2String(lengthOverride, DataStream.BIG_ENDIAN); break;

    default:
      if (t.length == 3) {
        var ta = t[1];
        var len = t[2];
        var length = 0;
        if (typeof len == 'function') {
          length = len(struct, this, t);
        } else if (typeof len == 'string' && struct[len] != null) {
          length = parseInt(struct[len]);
        } else {
          length = parseInt(len);
        }
        if (typeof ta == "string") {
          var tap = ta.replace(/(le|be)$/, '');
          var endianness = null;
          if (/le$/.test(ta)) {
            endianness = DataStream.LITTLE_ENDIAN;
          } else if (/be$/.test(ta)) {
            endianness = DataStream.BIG_ENDIAN;
          }
          if (len == '*') {
            length = null;
          }
          switch(tap) {
            case 'uint8':
              v = this.readUint8Array(length); break;
            case 'uint16':
              v = this.readUint16Array(length, endianness); break;
            case 'uint32':
              v = this.readUint32Array(length, endianness); break;
            case 'int8':
              v = this.readInt8Array(length); break;
            case 'int16':
              v = this.readInt16Array(length, endianness); break;
            case 'int32':
              v = this.readInt32Array(length, endianness); break;
            case 'float32':
              v = this.readFloat32Array(length, endianness); break;
            case 'float64':
              v = this.readFloat64Array(length, endianness); break;
            case 'cstring':
            case 'utf16string':
            case 'string':
              if (length == null) {
                v = [];
                while (!this.isEof()) {
                  var u = this.readType(ta, struct);
                  if (u == null) break;
                  v.push(u);
                }
              } else {
                v = new Array(length);
                for (var i=0; i<length; i++) {
                  v[i] = this.readType(ta, struct);
                }
              }
              break;
          }
        } else {
          if (len == '*') {
            v = [];
            this.buffer;
            while (true) {
              var p = this.position;
              try {
                var o = this.readType(ta, struct);
                if (o == null) {
                  this.position = p;
                  break;
                }
                v.push(o);
              } catch(e) {
                this.position = p;
                break;
              }
            }
          } else {
            v = new Array(length);
            for (var i=0; i<length; i++) {
              var u = this.readType(ta, struct);
              if (u == null) return null;
              v[i] = u;
            }
          }
        }
        break;
      }
  }
  if (lengthOverride != null) {
    this.position = pos + lengthOverride;
  }
  return v;
};

/**
  Writes a struct to the DataStream. Takes a structDefinition that gives the
  types and a struct object that gives the values. Refer to readStruct for the
  structure of structDefinition.

  @param {Object} structDefinition Type definition of the struct.
  @param {Object} struct The struct data object.
  */
DataStream.prototype.writeStruct = function(structDefinition, struct) {
  for (var i = 0; i < structDefinition.length; i+=2) {
    var t = structDefinition[i+1];
    this.writeType(t, struct[structDefinition[i]], struct);
  }
};

/**
  Writes object v of type t to the DataStream.

  @param {Object} t Type of data to write.
  @param {Object} v Value of data to write.
  @param {Object} struct Struct to pass to write callback functions.
  */
DataStream.prototype.writeType = function(t, v, struct) {
  if (typeof t == "function") {
    return t(this, v);
  } else if (typeof t == "object" && !(t instanceof Array)) {
    return t.set(this, v, struct);
  }
  var lengthOverride = null;
  var charset = "ASCII";
  var pos = this.position;
  if (typeof(t) == 'string' && /:/.test(t)) {
    var tp = t.split(":");
    t = tp[0];
    lengthOverride = parseInt(tp[1]);
  }
  if (typeof t == 'string' && /,/.test(t)) {
    var tp = t.split(",");
    t = tp[0];
    charset = parseInt(tp[1]);
  }

  switch(t) {
    case 'uint8':
      this.writeUint8(v);
      break;
    case 'int8':
      this.writeInt8(v);
      break;

    case 'uint16':
      this.writeUint16(v, this.endianness);
      break;
    case 'int16':
      this.writeInt16(v, this.endianness);
      break;
    case 'uint32':
      this.writeUint32(v, this.endianness);
      break;
    case 'int32':
      this.writeInt32(v, this.endianness);
      break;
    case 'float32':
      this.writeFloat32(v, this.endianness);
      break;
    case 'float64':
      this.writeFloat64(v, this.endianness);
      break;

    case 'uint16be':
      this.writeUint16(v, DataStream.BIG_ENDIAN);
      break;
    case 'int16be':
      this.writeInt16(v, DataStream.BIG_ENDIAN);
      break;
    case 'uint32be':
      this.writeUint32(v, DataStream.BIG_ENDIAN);
      break;
    case 'int32be':
      this.writeInt32(v, DataStream.BIG_ENDIAN);
      break;
    case 'float32be':
      this.writeFloat32(v, DataStream.BIG_ENDIAN);
      break;
    case 'float64be':
      this.writeFloat64(v, DataStream.BIG_ENDIAN);
      break;

    case 'uint16le':
      this.writeUint16(v, DataStream.LITTLE_ENDIAN);
      break;
    case 'int16le':
      this.writeInt16(v, DataStream.LITTLE_ENDIAN);
      break;
    case 'uint32le':
      this.writeUint32(v, DataStream.LITTLE_ENDIAN);
      break;
    case 'int32le':
      this.writeInt32(v, DataStream.LITTLE_ENDIAN);
      break;
    case 'float32le':
      this.writeFloat32(v, DataStream.LITTLE_ENDIAN);
      break;
    case 'float64le':
      this.writeFloat64(v, DataStream.LITTLE_ENDIAN);
      break;

    case 'cstring':
      this.writeCString(v, lengthOverride);
      break;

    case 'string':
      this.writeString(v, charset, lengthOverride);
      break;

    case 'u16string':
      this.writeUCS2String(v, this.endianness, lengthOverride);
      break;

    case 'u16stringle':
      this.writeUCS2String(v, DataStream.LITTLE_ENDIAN, lengthOverride);
      break;

    case 'u16stringbe':
      this.writeUCS2String(v, DataStream.BIG_ENDIAN, lengthOverride);
      break;

    default:
      if (t.length == 3) {
        var ta = t[1];
        for (var i=0; i<v.length; i++) {
          this.writeType(ta, v[i]);
        }
        break;
      } else {
        this.writeStruct(t, v);
        break;
      }
  }
  if (lengthOverride != null) {
    this.position = pos;
    this._realloc(lengthOverride);
    this.position = pos + lengthOverride;
  }
};

// Export DataStream for amd environments
if (typeof define === 'function' && define.amd) {
    define('DataStream', [], function() {
      return DataStream;
    });
  }
  
// Export DataStream for CommonJS
if (typeof module === 'object' && module && module.exports) {
  module.exports = DataStream;
}
</script>
<!--###############################################################################___END DATASTREAM BEGIN MSG READER__################################################-->
<script>/* Copyright 2021 Yury Karpovich
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*
 MSG Reader
 */

(function () {

  // constants
  var CONST = {
    FILE_HEADER: uInt2int([0xD0, 0xCF, 0x11, 0xE0, 0xA1, 0xB1, 0x1A, 0xE1]),
    MSG: {
      UNUSED_BLOCK: -1,
      END_OF_CHAIN: -2,

      S_BIG_BLOCK_SIZE: 0x0200,
      S_BIG_BLOCK_MARK: 9,

      L_BIG_BLOCK_SIZE: 0x1000,
      L_BIG_BLOCK_MARK: 12,

      SMALL_BLOCK_SIZE: 0x0040,
      BIG_BLOCK_MIN_DOC_SIZE: 0x1000,
      HEADER: {
        PROPERTY_START_OFFSET: 0x30,

        BAT_START_OFFSET: 0x4c,
        BAT_COUNT_OFFSET: 0x2C,

        SBAT_START_OFFSET: 0x3C,
        SBAT_COUNT_OFFSET: 0x40,

        XBAT_START_OFFSET: 0x44,
        XBAT_COUNT_OFFSET: 0x48
      },
      PROP: {
        NO_INDEX: -1,
        PROPERTY_SIZE: 0x0080,

        NAME_SIZE_OFFSET: 0x40,
        MAX_NAME_LENGTH: (/*NAME_SIZE_OFFSET*/0x40 / 2) - 1,
        TYPE_OFFSET: 0x42,
        PREVIOUS_PROPERTY_OFFSET: 0x44,
        NEXT_PROPERTY_OFFSET: 0x48,
        CHILD_PROPERTY_OFFSET: 0x4C,
        START_BLOCK_OFFSET: 0x74,
        SIZE_OFFSET: 0x78,
        TYPE_ENUM: {
          DIRECTORY: 1,
          DOCUMENT: 2,
          ROOT: 5
        }
      },
      FIELD: {
        PREFIX: {
          ATTACHMENT: '__attach_version1.0',
          RECIPIENT: '__recip_version1.0',
          DOCUMENT: '__substg1.'
        },
        // example (use fields as needed)
        NAME_MAPPING: {
          // email specific
          '0037': 'subject',
          '0c1a': 'senderName',
          '5d02': 'senderEmail',
          '1000': 'body',
          '1013': 'bodyHTML',
          '007d': 'headers',
          // attachment specific
          '3703': 'extension',
          '3704': 'fileNameShort',
          '3707': 'fileName',
          '3712': 'pidContentId',
          '370e': 'mimeType',
          // recipient specific
          '3001': 'name',
          '39fe': 'email'
        },
        CLASS_MAPPING: {
          ATTACHMENT_DATA: '3701'
        },
        TYPE_MAPPING: {
          '001e': 'string',
          '001f': 'unicode',
          '0102': 'binary'
        },
        DIR_TYPE: {
          INNER_MSG: '000d'
        }
      }
    }
  };

  // unit utils
  function arraysEqual(a, b) {
    if (a === b) return true;
    if (a == null || b == null) return false;
    if (a.length != b.length) return false;

    for (var i = 0; i < a.length; i++) {
      if (a[i] !== b[i]) return false;
    }
    return true;
  }

  function uInt2int(data) {
    var result = new Array(data.length);
    for (var i = 0; i < data.length; i++) {
      result[i] = data[i] << 24 >> 24;
    }
    return result;
  }

  // MSG Reader implementation

  // check MSG file header
  function isMSGFile(ds) {
    ds.seek(0);
    return arraysEqual(CONST.FILE_HEADER, ds.readInt8Array(CONST.FILE_HEADER.length));
  }

  // FAT utils
  function getBlockOffsetAt(msgData, offset) {
    return (offset + 1) * msgData.bigBlockSize;
  }

  function getBlockAt(ds, msgData, offset) {
    var startOffset = getBlockOffsetAt(msgData, offset);
    ds.seek(startOffset);
    return ds.readInt32Array(msgData.bigBlockLength);
  }

  function getNextBlockInner(ds, msgData, offset, blockOffsetData) {
    var currentBlock = Math.floor(offset / msgData.bigBlockLength);
    var currentBlockIndex = offset % msgData.bigBlockLength;

    var startBlockOffset = blockOffsetData[currentBlock];

    return getBlockAt(ds, msgData, startBlockOffset)[currentBlockIndex];
  }

  function getNextBlock(ds, msgData, offset) {
    return getNextBlockInner(ds, msgData, offset, msgData.batData);
  }

  function getNextBlockSmall(ds, msgData, offset) {
    return getNextBlockInner(ds, msgData, offset, msgData.sbatData);
  }

  // convert binary data to dictionary
  function parseMsgData(ds) {
    var msgData = headerData(ds);
    msgData.batData = batData(ds, msgData);
    msgData.sbatData = sbatData(ds, msgData);
    if (msgData.xbatCount > 0) {
      xbatData(ds, msgData);
    }
    msgData.propertyData = propertyData(ds, msgData);
    msgData.fieldsData = fieldsData(ds, msgData);

    return msgData;
  }

  // extract header data
  function headerData(ds) {
    var headerData = {};

    // system data
    headerData.bigBlockSize =
      ds.readByte(/*const position*/30) == CONST.MSG.L_BIG_BLOCK_MARK ? CONST.MSG.L_BIG_BLOCK_SIZE : CONST.MSG.S_BIG_BLOCK_SIZE;
    headerData.bigBlockLength = headerData.bigBlockSize / 4;
    headerData.xBlockLength = headerData.bigBlockLength - 1;

    // header data
    headerData.batCount = ds.readInt(CONST.MSG.HEADER.BAT_COUNT_OFFSET);
    headerData.propertyStart = ds.readInt(CONST.MSG.HEADER.PROPERTY_START_OFFSET);
    headerData.sbatStart = ds.readInt(CONST.MSG.HEADER.SBAT_START_OFFSET);
    headerData.sbatCount = ds.readInt(CONST.MSG.HEADER.SBAT_COUNT_OFFSET);
    headerData.xbatStart = ds.readInt(CONST.MSG.HEADER.XBAT_START_OFFSET);
    headerData.xbatCount = ds.readInt(CONST.MSG.HEADER.XBAT_COUNT_OFFSET);

    return headerData;
  }

  function batCountInHeader(msgData) {
    var maxBatsInHeader = (CONST.MSG.S_BIG_BLOCK_SIZE - CONST.MSG.HEADER.BAT_START_OFFSET) / 4;
    return Math.min(msgData.batCount, maxBatsInHeader);
  }

  function batData(ds, msgData) {
    var result = new Array(batCountInHeader(msgData));
    ds.seek(CONST.MSG.HEADER.BAT_START_OFFSET);
    for (var i = 0; i < result.length; i++) {
      result[i] = ds.readInt32()
    }
    return result;
  }

  function sbatData(ds, msgData) {
    var result = [];
    var startIndex = msgData.sbatStart;

    for (var i = 0; i < msgData.sbatCount && startIndex != CONST.MSG.END_OF_CHAIN; i++) {
      result.push(startIndex);
      startIndex = getNextBlock(ds, msgData, startIndex);
    }
    return result;
  }

  function xbatData(ds, msgData) {
    var batCount = batCountInHeader(msgData);
    var batCountTotal = msgData.batCount;
    var remainingBlocks = batCountTotal - batCount;

    var nextBlockAt = msgData.xbatStart;
    for (var i = 0; i < msgData.xbatCount; i++) {
      var xBatBlock = getBlockAt(ds, msgData, nextBlockAt);
      nextBlockAt = xBatBlock[msgData.xBlockLength];

      var blocksToProcess = Math.min(remainingBlocks, msgData.xBlockLength);
      for (var j = 0; j < blocksToProcess; j++) {
        var blockStartAt = xBatBlock[j];
        if (blockStartAt == CONST.MSG.UNUSED_BLOCK || blockStartAt == CONST.MSG.END_OF_CHAIN) {
          break;
        }
        msgData.batData.push(blockStartAt);
      }
      remainingBlocks -= blocksToProcess;
    }
  }

  // extract property data and property hierarchy
  function propertyData(ds, msgData) {
    var props = [];

    var currentOffset = msgData.propertyStart;

    while (currentOffset != CONST.MSG.END_OF_CHAIN) {
      convertBlockToProperties(ds, msgData, currentOffset, props);
      currentOffset = getNextBlock(ds, msgData, currentOffset);
    }
    createPropertyHierarchy(props, /*property with index 0 (zero) always as root*/props[0]);
    return props;
  }

  function convertName(ds, offset) {
    var nameLength = ds.readShort(offset + CONST.MSG.PROP.NAME_SIZE_OFFSET);
    if (nameLength < 1) {
      return '';
    } else {
      return ds.readStringAt(offset, nameLength / 2);
    }
  }

  function convertProperty(ds, index, offset) {
    return {
      index: index,
      type: ds.readByte(offset + CONST.MSG.PROP.TYPE_OFFSET),
      name: convertName(ds, offset),
      // hierarchy
      previousProperty: ds.readInt(offset + CONST.MSG.PROP.PREVIOUS_PROPERTY_OFFSET),
      nextProperty: ds.readInt(offset + CONST.MSG.PROP.NEXT_PROPERTY_OFFSET),
      childProperty: ds.readInt(offset + CONST.MSG.PROP.CHILD_PROPERTY_OFFSET),
      // data offset
      startBlock: ds.readInt(offset + CONST.MSG.PROP.START_BLOCK_OFFSET),
      sizeBlock: ds.readInt(offset + CONST.MSG.PROP.SIZE_OFFSET)
    };
  }

  function convertBlockToProperties(ds, msgData, propertyBlockOffset, props) {

    var propertyCount = msgData.bigBlockSize / CONST.MSG.PROP.PROPERTY_SIZE;
    var propertyOffset = getBlockOffsetAt(msgData, propertyBlockOffset);

    for (var i = 0; i < propertyCount; i++) {
      var propertyType = ds.readByte(propertyOffset + CONST.MSG.PROP.TYPE_OFFSET);
      switch (propertyType) {
        case CONST.MSG.PROP.TYPE_ENUM.ROOT:
        case CONST.MSG.PROP.TYPE_ENUM.DIRECTORY:
        case CONST.MSG.PROP.TYPE_ENUM.DOCUMENT:
          props.push(convertProperty(ds, props.length, propertyOffset));
          break;
        default:
          /* unknown property types */
          props.push(null);
      }

      propertyOffset += CONST.MSG.PROP.PROPERTY_SIZE;
    }
  }

  function createPropertyHierarchy(props, nodeProperty) {

    if (nodeProperty.childProperty == CONST.MSG.PROP.NO_INDEX) {
      return;
    }
    nodeProperty.children = [];

    var children = [nodeProperty.childProperty];
    while (children.length != 0) {
      var currentIndex = children.shift();
      var current = props[currentIndex];
      if (current == null) {
        continue;
      }
      nodeProperty.children.push(currentIndex);

      if (current.type == CONST.MSG.PROP.TYPE_ENUM.DIRECTORY) {
        createPropertyHierarchy(props, current);
      }
      if (current.previousProperty != CONST.MSG.PROP.NO_INDEX) {
        children.push(current.previousProperty);
      }
      if (current.nextProperty != CONST.MSG.PROP.NO_INDEX) {
        children.push(current.nextProperty);
      }
    }
  }

  // extract real fields
  function fieldsData(ds, msgData) {
    var fields = {
      attachments: [],
      recipients: []
    };
    fieldsDataDir(ds, msgData, msgData.propertyData[0], fields);
    return fields;
  }

  function fieldsDataDir(ds, msgData, dirProperty, fields) {

    if (dirProperty.children && dirProperty.children.length > 0) {
      for (var i = 0; i < dirProperty.children.length; i++) {
        var childProperty = msgData.propertyData[dirProperty.children[i]];

        if (childProperty.type == CONST.MSG.PROP.TYPE_ENUM.DIRECTORY) {
          fieldsDataDirInner(ds, msgData, childProperty, fields)
        } else if (childProperty.type == CONST.MSG.PROP.TYPE_ENUM.DOCUMENT
          && childProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.DOCUMENT) == 0) {
          fieldsDataDocument(ds, msgData, childProperty, fields);
        }
      }
    }
  }

  function fieldsDataDirInner(ds, msgData, dirProperty, fields) {
    if (dirProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.ATTACHMENT) == 0) {

      // attachment
      var attachmentField = {};
      fields.attachments.push(attachmentField);
      fieldsDataDir(ds, msgData, dirProperty, attachmentField);
    } else if (dirProperty.name.indexOf(CONST.MSG.FIELD.PREFIX.RECIPIENT) == 0) {

      // recipient
      var recipientField = {};
      fields.recipients.push(recipientField);
      fieldsDataDir(ds, msgData, dirProperty, recipientField);
    } else {

      // other dir
      var childFieldType = getFieldType(dirProperty);
      if (childFieldType != CONST.MSG.FIELD.DIR_TYPE.INNER_MSG) {
        fieldsDataDir(ds, msgData, dirProperty, fields);
      } else {
        // MSG as attachment currently isn't supported
        fields.innerMsgContent = true;
      }
    }
  }

  function isAddPropertyValue(fieldName, fieldTypeMapped) {
    return fieldName !== 'body' || fieldTypeMapped !== 'binary';
  }

  function fieldsDataDocument(ds, msgData, documentProperty, fields) {
    var value = documentProperty.name.substring(12).toLowerCase();
    var fieldClass = value.substring(0, 4);
    var fieldType = value.substring(4, 8);

    var fieldName = CONST.MSG.FIELD.NAME_MAPPING[fieldClass];
    var fieldTypeMapped = CONST.MSG.FIELD.TYPE_MAPPING[fieldType];

    if (fieldName) {
      var fieldValue = getFieldValue(ds, msgData, documentProperty, fieldTypeMapped);

      if (isAddPropertyValue(fieldName, fieldTypeMapped)) {
        fields[fieldName] = applyValueConverter(fieldName, fieldTypeMapped, fieldValue);
      }
    }
    if (fieldClass == CONST.MSG.FIELD.CLASS_MAPPING.ATTACHMENT_DATA) {

      // attachment specific info
      fields['dataId'] = documentProperty.index;
      fields['contentLength'] = documentProperty.sizeBlock;
    }
  }

  // todo: html body test
  function applyValueConverter(fieldName, fieldTypeMapped, fieldValue) {
    if (fieldTypeMapped === 'binary' && fieldName === 'bodyHTML') {
      return convertUint8ArrayToString(fieldValue);
    }
    return fieldValue
  }

  function getFieldType(fieldProperty) {
    var value = fieldProperty.name.substring(12).toLowerCase();
    return value.substring(4, 8);
  }

  // extractor structure to manage bat/sbat block types and different data types
  var extractorFieldValue = {
    sbat: {
      'extractor': function extractDataViaSbat(ds, msgData, fieldProperty, dataTypeExtractor) {
        var chain = getChainByBlockSmall(ds, msgData, fieldProperty);
        if (chain.length == 1) {
          return readDataByBlockSmall(ds, msgData, fieldProperty.startBlock, fieldProperty.sizeBlock, dataTypeExtractor);
        } else if (chain.length > 1) {
          return readChainDataByBlockSmall(ds, msgData, fieldProperty, chain, dataTypeExtractor);
        }
        return null;
      },
      dataType: {
        'string': function extractBatString(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {
          ds.seek(blockStartOffset + bigBlockOffset);
          return ds.readString(blockSize);
        },
        'unicode': function extractBatUnicode(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {
          ds.seek(blockStartOffset + bigBlockOffset);
          return ds.readUCS2String(blockSize / 2);
        },
        'binary': function extractBatBinary(ds, msgData, blockStartOffset, bigBlockOffset, blockSize) {
          ds.seek(blockStartOffset + bigBlockOffset);
          return ds.readUint8Array(blockSize);
        }
      }
    },
    bat: {
      'extractor': function extractDataViaBat(ds, msgData, fieldProperty, dataTypeExtractor) {
        var offset = getBlockOffsetAt(msgData, fieldProperty.startBlock);
        ds.seek(offset);
        return dataTypeExtractor(ds, fieldProperty);
      },
      dataType: {
        'string': function extractSbatString(ds, fieldProperty) {
          return ds.readString(fieldProperty.sizeBlock);
        },
        'unicode': function extractSbatUnicode(ds, fieldProperty) {
          return ds.readUCS2String(fieldProperty.sizeBlock / 2);
        },
        'binary': function extractSbatBinary(ds, fieldProperty) {
          return ds.readUint8Array(fieldProperty.sizeBlock);
        }
      }
    }
  };

  function readDataByBlockSmall(ds, msgData, startBlock, blockSize, dataTypeExtractor) {
    var byteOffset = startBlock * CONST.MSG.SMALL_BLOCK_SIZE;
    var bigBlockNumber = Math.floor(byteOffset / msgData.bigBlockSize);
    var bigBlockOffset = byteOffset % msgData.bigBlockSize;

    var rootProp = msgData.propertyData[0];

    var nextBlock = rootProp.startBlock;
    for (var i = 0; i < bigBlockNumber; i++) {
      nextBlock = getNextBlock(ds, msgData, nextBlock);
    }
    var blockStartOffset = getBlockOffsetAt(msgData, nextBlock);

    return dataTypeExtractor(ds, msgData, blockStartOffset, bigBlockOffset, blockSize);
  }

  function readChainDataByBlockSmall(ds, msgData, fieldProperty, chain, dataTypeExtractor) {
    var resultData = new Int8Array(fieldProperty.sizeBlock);

    for (var i = 0, idx = 0; i < chain.length; i++) {
      var data = readDataByBlockSmall(ds, msgData, chain[i], CONST.MSG.SMALL_BLOCK_SIZE, extractorFieldValue.sbat.dataType.binary);
      for (var j = 0; j < data.length; j++) {
        resultData[idx++] = data[j];
      }
    }
    var localDs = new DataStream(resultData, 0, DataStream.LITTLE_ENDIAN);
    return dataTypeExtractor(localDs, msgData, 0, 0, fieldProperty.sizeBlock);
  }

  function getChainByBlockSmall(ds, msgData, fieldProperty) {
    var blockChain = [];
    var nextBlockSmall = fieldProperty.startBlock;
    while (nextBlockSmall != CONST.MSG.END_OF_CHAIN) {
      blockChain.push(nextBlockSmall);
      nextBlockSmall = getNextBlockSmall(ds, msgData, nextBlockSmall);
    }
    return blockChain;
  }

  function getFieldValue(ds, msgData, fieldProperty, typeMapped) {
    var value = null;

    var valueExtractor =
      fieldProperty.sizeBlock < CONST.MSG.BIG_BLOCK_MIN_DOC_SIZE ? extractorFieldValue.sbat : extractorFieldValue.bat;
    var dataTypeExtractor = valueExtractor.dataType[typeMapped];

    if (dataTypeExtractor) {
      value = valueExtractor.extractor(ds, msgData, fieldProperty, dataTypeExtractor);
    }
    return value;
  }

  function convertUint8ArrayToString(uint8ArraValue) {
    return new TextDecoder("utf-8").decode(uint8ArraValue);
  }

  // MSG Reader
  var MSGReader = function (arrayBuffer) {
    this.ds = new DataStream(arrayBuffer, 0, DataStream.LITTLE_ENDIAN);
  };

  MSGReader.prototype = {
    /**
     Converts bytes to fields information

     @return {Object} The fields data for MSG file
     */
    getFileData: function () {
      if (!isMSGFile(this.ds)) {
        return {error: 'Unsupported file type!'};
      }
      if (this.fileData == null) {
        this.fileData = parseMsgData(this.ds);
      }
      return this.fileData.fieldsData;
    },
    /**
     Reads an attachment content by key/ID

     @return {Object} The attachment for specific attachment key
     */
    getAttachment: function (attach) {
      var attachData = typeof attach === 'number' ? this.fileData.fieldsData.attachments[attach] : attach;
      var fieldProperty = this.fileData.propertyData[attachData.dataId];
      var fieldTypeMapped = CONST.MSG.FIELD.TYPE_MAPPING[getFieldType(fieldProperty)];
      var fieldData = getFieldValue(this.ds, this.fileData, fieldProperty, fieldTypeMapped);

      return {fileName: attachData.fileName, content: fieldData};
    }
  };

  window.MSGReader = MSGReader;

})();</script>
<!--###############################################################################___END MSG READER BEGIN HTML__################################################-->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Outlook Inbox Organizer</h1>
            <div class="language-toggle">
                <span class="lang-label">Content Language:</span>
                <div class="toggle-switch" id="languageToggle">
                    <input type="checkbox" id="langSwitch" />
                    <div class="toggle-container">
                        <div class="toggle-labels">
                            <span class="toggle-label-text en-label">EN</span>
                            <span class="toggle-label-text es-label">ES</span>
                        </div>
                        <label for="langSwitch" class="toggle-label"></label>
                    </div>
                </div>
            </div>
        </div>

        <div class="connect-section">
            <div class="connect-left">
                <button class="btn">Connect to Outlook</button>
                <span class="status">Status: Disconnected</span>
            </div>
            <div class="connect-right">
                <div class="import-btn-wrapper">
                    <input type="file" id="emailFileInput" multiple accept=".msg" style="display:none" />
                    <button class="btn import-drop-btn" id="importButton" onclick="document.getElementById('emailFileInput').click()">Import .MSG Emails</button>
                </div>
                <button class="gear-btn" onclick="openFilterModal()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('timeline')">Project Timeline</button>
            <button class="tab" onclick="showTab('actions')">My Actions</button>
            <button class="tab" onclick="showTab('attachments')">Attachments</button>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalEmails">0</div>
                    <div class="stat-label">Total Emails</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeProjects">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingActions">0</div>
                    <div class="stat-label">Pending Actions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedActions">0</div>
                    <div class="stat-label">Completed Actions</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Project/Topic</label>
                    <select id="projectFilter" onchange="filterEmails()">
                        <option value="">All Projects</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sender</label>
                    <select id="senderFilter" onchange="filterEmails()">
                        <option value="">All Senders</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Has Actions</label>
                    <select id="actionFilter" onchange="filterEmails()">
                        <option value="">All</option>
                        <option value="true">Has Actions</option>
                        <option value="false">No Actions</option>
                    </select>
                </div>
                <div class="search-group">
                    <label>Search</label>
                    <input type="text" id="searchInput" class="search-input" 
                           placeholder="Search emails by subject, sender, or content..." 
                           oninput="filterEmails()" />
                </div>
            </div>

            <div class="email-grid" id="emailGrid">
                <div class="loading">Loading emails...</div>
            </div>
        </div>

        <div id="timeline" class="tab-content hidden">
            <div class="filters">
                <div class="filter-group">
                    <label>Select Project</label>
                    <select id="timelineProjectFilter" onchange="loadTimeline()">
                        <option value="">Choose a project</option>
                    </select>
                </div>
            </div>
            <div class="timeline" id="timelineContainer">
                <p>Select a project to view its timeline</p>
            </div>
        </div>

        <div id="actions" class="tab-content hidden">
            <div class="filters">
                <div class="filter-group">
                    <label>Sort by</label>
                    <select id="actionSortFilter" onchange="sortActions()">
                        <option value="dueDate">Due Date</option>
                        <option value="priority">Priority</option>
                        <option value="project">Project</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Priority</label>
                    <select id="priorityFilter" onchange="filterActions()">
                        <option value="">All Priorities</option>
                        <option value="high">High Priority</option>
                        <option value="medium">Medium Priority</option>
                        <option value="low">Low Priority</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="statusFilter" onchange="filterActions()">
                        <option value="">All Tasks</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p id="progressText">0% complete (0 of 0 tasks)</p>
            <div class="kanban-board" id="kanbanBoard">
                <div class="kanban-column pending-column" id="pendingColumn">
                    <div class="kanban-header">
                        <div class="kanban-title">Pending</div>
                        <div class="kanban-count" id="pendingCount">0 tasks</div>
                    </div>
                    <div class="kanban-content" id="pendingContent">
                        <!-- Pending tasks will be added here -->
                    </div>
                </div>
                
                <div class="kanban-column progress-column" id="progressColumn">
                    <div class="kanban-header">
                        <div class="kanban-title">In Progress</div>
                        <div class="kanban-count" id="progressCount">0 tasks</div>
                    </div>
                    <div class="kanban-content" id="progressContent">
                        <!-- In progress tasks will be added here -->
                    </div>
                </div>
                
                <div class="kanban-column completed-column" id="completedColumn">
                    <div class="kanban-header">
                        <div class="kanban-title">Completed Today</div>
                        <div class="kanban-count" id="completedCount">0 tasks</div>
                    </div>
                    <div class="kanban-content" id="completedContent">
                        <!-- Completed tasks will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="attachments" class="tab-content hidden">
            <div class="filters">
                <div class="filter-group">
                    <label>File Type</label>
                    <select id="fileTypeFilter" onchange="filterAttachments()">
                        <option value="">All Types</option>
                        <option value="pdf">PDF</option>
                        <option value="doc">Documents</option>
                        <option value="xls">Spreadsheets</option>
                        <option value="img">Images</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Project</label>
                    <select id="attachmentProjectFilter" onchange="filterAttachments()">
                        <option value="">All Projects</option>
                    </select>
                </div>
            </div>
            <table class="attachments-table" id="attachmentsTable">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Project</th>
                        <th>Email Subject</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="attachmentsTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">Loading attachments...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="filter-modal">
        <div class="filter-modal-content">
            <div class="filter-modal-header">
                <h2>Email Filter Rules</h2>
                <button class="close-btn" onclick="closeFilterModal()">&times;</button>
            </div>
            <div class="filter-add-section">
                <h3>Add New Filter Rule</h3>
                <div class="filter-input-group">
                    <input type="text" id="newFilterInput" class="filter-input" placeholder="Enter filter rule (e.g., sender:spam@example.com)">
                    <button class="add-filter-btn" onclick="addFilterRule()">Add Rule</button>
                </div>
            </div>
            <div class="filter-list">
                <h3>Active Filter Rules</h3>
                <div id="filterRulesList">
                    <!-- Filter rules will be added here -->
                </div>
            </div>
            <div class="filter-stats">
                <span id="filterStats">No filters active</span>
            </div>
        </div>
    </div>

    <!-- ########## NEW LOADER OVERLAY ########## -->
    <div id="loaderOverlay" class="loader-overlay" style="display: none;">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div id="loaderText" class="loader-text">Processing...</div>
            <div id="loaderSubtext" class="loader-subtext">Please wait.</div>
        </div>
    </div>
    <!-- ########## END NEW LOADER OVERLAY ########## -->

    <script>
        // Global state
        let emails = [];
        let actions = [];
        let attachments = [];
        let projects = new Set();
        let senders = new Set();
        let isConnected = false;

        // Global language setting
        let currentLanguage = 'original'; // 'original', 'en', 'es'

        // ########## LOADER HELPER FUNCTIONS ##########
        function showLoader(text, subtext = '') {
            document.getElementById('loaderOverlay').style.display = 'flex';
            document.getElementById('loaderText').textContent = text;
            document.getElementById('loaderSubtext').textContent = subtext;
        }

        function updateLoader(text, subtext = '') {
            document.getElementById('loaderText').textContent = text;
            document.getElementById('loaderSubtext').textContent = subtext;
        }

        function hideLoader() {
            document.getElementById('loaderOverlay').style.display = 'none';
        }
        // ########## END LOADER HELPER FUNCTIONS ##########

        // Utility function to clear all state
        function clearState() {
            emails = [];
            actions = [];
            attachments = [];
            projects = new Set();
            senders = new Set();
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize drag and drop for import button
            initializeImportButtonDragDrop();
            
            // Initialize language toggle
            initializeLanguageToggle();
            
            // Try loading saved data first
            const savedEmails = JSON.parse(localStorage.getItem('emails') || '[]');
            if (savedEmails.length) {
                clearState(); 
                emails = savedEmails;
                // Re-populate actions, attachments, projects, senders from loaded emails
                emails.forEach(email => {
                    projects.add(email.project);
                    senders.add(email.sender);
                    (email.attachments || []).forEach(attachmentName => { // Use attachmentName for consistency
                        attachments.push({
                            name: attachmentName, // Directly use the name from the email's attachments array
                            project: email.project,
                            emailSubject: email.subject,
                            date: email.date,
                            emailId: email.id
                        });
                    });
                    (email.actions || []).forEach(action => {
                        console.log('Processing action:', action);
                        if (action.isMyAction) {
                            // Ensure backward compatibility for existing data
                            let status = action.status || 'pending';
                            if (!action.status && action.completed) {
                                status = 'completed';
                            }
                            
                            const processedAction = {
                                ...action,
                                emailId: email.id,
                                emailSubject: email.subject,
                                completed: action.completed || false,
                                priority: action.priority || 'medium',
                                status: status,
                                completedDate: action.completedDate || null
                            };
                            
                            console.log('Adding action to actions array:', processedAction);
                            actions.push(processedAction);
                        } else {
                            console.log('Skipping action (not isMyAction):', action);
                        }
                    });
                });
                console.log('Final actions array before rendering:', actions);
                populateFilters();
                renderEmails();
                console.log('About to call renderActions...');
                renderActions();
                renderAttachments();
                updateStats();
            } else {
                // No saved data  use sample/demo data if you want, or just start empty
                clearState(); // Ensure a clean slate
                loadSampleData(); // Keep this for initial demo if no files are uploaded
            }
        });

        // Initialize drag and drop for import button
        function initializeImportButtonDragDrop() {
            const importButton = document.getElementById('importButton');
            const emailFileInput = document.getElementById('emailFileInput');

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                importButton.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                importButton.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                importButton.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                importButton.classList.add('drag-over');
            }

            function unhighlight(e) {
                importButton.classList.remove('drag-over');
            }

            // Handle dropped files
            importButton.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            // Handle file input change
            emailFileInput.addEventListener('change', function(e) {
                handleFiles(this.files);
            });
        }

        // Outlook connection (placeholder for actual API integration)
        async function connectOutlook() {
            const btn = event.target;
            const status = document.getElementById('connectionStatus');
            
            btn.textContent = 'Connecting...';
            btn.disabled = true;

            // Simulate API connection
            setTimeout(() => {
                isConnected = true;
                btn.textContent = 'Connected';
                status.textContent = 'Connected';
                status.className = 'status connected';
                
                // In a real app, this would trigger fetching emails
                // For this local app, connection simply changes status
            }, 2000);
        }

        // Load sample data for demonstration (only if no files are loaded)
        function loadSampleData() {
            clearState(); // Ensure a clean state when loading sample data
            emails = [
                {
                    id: 1,
                    subject: "Project Alpha Milestone Review",
                    sender: "john.doe@company.com",
                    date: "2025-06-05",
                    project: "Project Alpha",
                    summary: "Review of Q2 milestones completed. Next phase planning scheduled for next week.",
                    actions: [
                        {
                            text: "Prepare presentation for stakeholder meeting",
                            responsible: "me",
                            dueDate: "2025-06-10",
                            isMyAction: true,
                            priority: 'high'
                        },
                        {
                            text: "Update project timeline",
                            responsible: "John Doe",
                            dueDate: "2025-06-08",
                            isMyAction: false,
                            priority: 'medium'
                        }
                    ],
                    attachments: ["milestone_report.pdf", "project_timeline.xlsx"]
                },
                {
                    id: 2,
                    subject: "Marketing Campaign Feedback",
                    sender: "sarah.wilson@company.com",
                    date: "2025-06-04",
                    project: "Marketing Campaign",
                    summary: "Positive feedback on initial campaign concepts. Request for budget adjustment and timeline extension.",
                    actions: [
                        {
                            text: "Review budget proposal",
                            responsible: "me",
                            dueDate: "2025-06-07",
                            isMyAction: true,
                            priority: 'high'
                        }
                    ],
                    attachments: ["campaign_concepts.pptx", "budget_breakdown.pdf"]
                },
                {
                    id: 3,
                    subject: "Technical Architecture Discussion",
                    sender: "mike.chen@company.com",
                    date: "2025-06-03",
                    project: "Project Alpha",
                    summary: "Discussion on database architecture choices. Need decision on NoSQL vs SQL approach.",
                    actions: [
                        {
                            text: "Research database performance benchmarks",
                            responsible: "Mike Chen",
                            dueDate: "2025-06-09",
                            isMyAction: false,
                            priority: 'low'
                        }
                    ],
                    attachments: ["architecture_diagram.png"]
                }
            ];

            // Extract projects and senders from sample data
            emails.forEach(email => {
                projects.add(email.project);
                senders.add(email.sender);
                email.actions.forEach(action => {
                    console.log('Sample data - Processing action:', action);
                    if (action.isMyAction) {
                        const processedAction = {
                            ...action,
                            emailId: email.id,
                            emailSubject: email.subject,
                            completed: action.completed || false,
                            priority: action.priority || 'medium',
                            status: action.status || 'pending',
                            completedDate: action.completedDate || null
                        };
                        console.log('Sample data - Adding action:', processedAction);
                        actions.push(processedAction);
                    } else {
                        console.log('Sample data - Skipping action (not isMyAction):', action);
                    }
                });
            });

            // Create attachments list from sample data
            emails.forEach(email => {
                email.attachments.forEach(attachment => {
                    attachments.push({
                        name: attachment,
                        project: email.project,
                        emailSubject: email.subject,
                        date: email.date,
                        emailId: email.id
                    });
                });
            });

            console.log('Sample data - Final actions array:', actions);
            populateFilters();
            renderEmails();
            console.log('Sample data - About to call renderActions...');
            renderActions();
            renderAttachments();
            updateStats();
        }

        // Populate filter dropdowns
        function populateFilters() {
            const projectFilter = document.getElementById('projectFilter');
            const senderFilter = document.getElementById('senderFilter');
            const timelineProjectFilter = document.getElementById('timelineProjectFilter');
            const attachmentProjectFilter = document.getElementById('attachmentProjectFilter');

            // Clear existing options
            projectFilter.innerHTML = '<option value="">All Projects</option>';
            senderFilter.innerHTML = '<option value="">All Senders</option>';
            timelineProjectFilter.innerHTML = '<option value="">Choose a project</option>';
            attachmentProjectFilter.innerHTML = '<option value="">All Projects</option>';

            // Add project options
            // Sort projects alphabetically for better UX
            Array.from(projects).sort().forEach(project => {
                projectFilter.innerHTML += `<option value="${project}">${project}</option>`;
                timelineProjectFilter.innerHTML += `<option value="${project}">${project}</option>`;
                attachmentProjectFilter.innerHTML += `<option value="${project}">${project}</option>`;
            });

            // Add sender options
            Array.from(senders).sort().forEach(sender => {
                senderFilter.innerHTML += `<option value="${sender}">${sender}</option>`;
            });
        }

        // Render emails in dashboard
        function renderEmails() {
            const grid = document.getElementById('emailGrid');
            
            // Apply current filters before rendering
            const currentProjectFilter = document.getElementById('projectFilter')?.value || '';
            const currentSenderFilter = document.getElementById('senderFilter')?.value || '';
            const currentActionFilter = document.getElementById('actionFilter')?.value || ''; // "true", "false", or ""
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';

            const filteredEmails = emails.filter(email => {
                const matchesProject = !currentProjectFilter || email.project === currentProjectFilter;
                const matchesSender = !currentSenderFilter || email.sender === currentSenderFilter;
                const matchesActions = currentActionFilter === "" || 
                                       (currentActionFilter === "true" && email.actions.length > 0) ||
                                       (currentActionFilter === "false" && email.actions.length === 0);
                
                // Search functionality - use display content (translated or original)
                const displayContent = getEmailDisplayContent(email);
                const matchesSearch = !searchQuery || 
                    displayContent.subject.toLowerCase().includes(searchQuery) ||
                    email.sender.toLowerCase().includes(searchQuery) ||
                    displayContent.summary.toLowerCase().includes(searchQuery) ||
                    email.project.toLowerCase().includes(searchQuery) ||
                    displayContent.actions.some(action => 
                        action.text.toLowerCase().includes(searchQuery) ||
                        action.responsible.toLowerCase().includes(searchQuery)
                    );
                
                return matchesProject && matchesSender && matchesActions && matchesSearch;
            });

            if (filteredEmails.length === 0) {
                const searchQuery = document.getElementById('searchInput')?.value || '';
                const message = searchQuery ? 
                    `No emails found matching search "${searchQuery}" and current filters.` : 
                    'No emails found matching current filters.';
                grid.innerHTML = `<div class="loading">${message}</div>`;
                return;
            }

            grid.innerHTML = filteredEmails.map(email => {
                const displayContent = getEmailDisplayContent(email);
                return `
                <div class="email-card">
                    <div class="email-header">
                        <div>
                            <div class="email-subject">${displayContent.subject}</div>
                            <div class="email-meta">
                                <span>From: ${email.sender}</span>
                                <span>Date: ${email.date}</span>
                                <span class="project-tag" onclick="editProjectTag(${email.id})" data-email-id="${email.id}">
                                    ${email.project}
                                    <div class="project-editor" id="editor-${email.id}">
                                        <label class="input-label" for="input-${email.id}">New Project Name:</label>
                                        <input type="text" id="input-${email.id}" value="${email.project}" placeholder="Enter project name">
                                        
                                        <div class="existing-projects">
                                            <span class="existing-projects-label">Or select existing:</span>
                                            <div class="project-buttons">
                                                ${Array.from(projects).map(p => `<button class="project-btn" onclick="document.getElementById('input-${email.id}').value = '${p}';">${p}</button>`).join('')}
                                            </div>
                                        </div>

                                        <div class="control-buttons">
                                            <button class="save-btn" onclick="saveProjectTag(${email.id})">Save</button>
                                            <button class="cancel-btn" onclick="cancelProjectEdit(${email.id})">Cancel</button>
                                        </div>
                                    </div>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="summary">${displayContent.summary}</div>
                    ${displayContent.actions.length > 0 ? `
                        <div class="actions">
                            <strong>Actions:</strong>
                            ${displayContent.actions.map(action => {
                                const isCompleted = isActionCompleted(action.text, action.responsible, action.dueDate, email.id);
                                return `
                                <div class="action-item ${action.isMyAction ? 'my-action' : ''} ${isCompleted ? 'completed' : ''}">
                                    <div class="action-text">${action.text}</div>
                                    <div class="action-meta">
                                        <div>Responsible: ${action.responsible}</div>
                                        <div>Due: ${action.dueDate}</div>
                                        <div>Priority: <span class="priority-${action.priority}">${action.priority.charAt(0).toUpperCase() + action.priority.slice(1)}</span></div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        // Render actions Kanban board
        function renderActions() {
            console.log('renderActions called, total actions:', actions.length);
            
            // Initialize Kanban drag and drop
            initializeKanbanDragDrop();
            
            // Apply current filters only to pending actions
            const priorityFilter = document.getElementById('priorityFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';

            // Separate actions by status
            const pendingActions = actions.filter(action => action.status === 'pending');
            const progressActions = actions.filter(action => action.status === 'progress');
            const completedActions = actions.filter(action => action.status === 'completed' && isCompletedToday(action));
            
            console.log('Actions by status:', {
                pending: pendingActions.length,
                progress: progressActions.length,
                completed: completedActions.length
            });

            // Apply filters only to pending actions
            let filteredPendingActions = [...pendingActions];
            
            if (priorityFilter) {
                filteredPendingActions = filteredPendingActions.filter(action => action.priority === priorityFilter);
            }

            if (statusFilter === 'pending') {
                filteredPendingActions = filteredPendingActions.filter(action => !action.completed);
            } else if (statusFilter === 'completed') {
                filteredPendingActions = []; // Hide pending if showing only completed
            }

            // Sort pending actions
            const sortBy = document.getElementById('actionSortFilter')?.value || 'dueDate';
            filteredPendingActions.sort((a, b) => compareActions(a, b, sortBy));

            // Render each column
            renderKanbanColumn('pendingContent', 'pendingCount', filteredPendingActions, 'pending');
            renderKanbanColumn('progressContent', 'progressCount', progressActions, 'progress');
            renderKanbanColumn('completedContent', 'completedCount', completedActions, 'completed');

            updateProgress();
        }

        // Helper function to check if action was completed today
        function isCompletedToday(action) {
            if (!action.completedDate) return false;
            const today = new Date().toDateString();
            const completedDate = new Date(action.completedDate).toDateString();
            return today === completedDate;
        }

        // Sort actions comparator helper
        function compareActions(a, b, sortBy) {
            if (sortBy === 'priority') {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            } else if (sortBy === 'dueDate') {
                const dateA = a.dueDate ? new Date(a.dueDate) : new Date('9999-12-31');
                const dateB = b.dueDate ? new Date(b.dueDate) : new Date('9999-12-31');
                return dateA - dateB;
            } else if (sortBy === 'project') {
                const projectA = emails.find(e => e.id === a.emailId)?.project || '';
                const projectB = emails.find(e => e.id === b.emailId)?.project || '';
                return projectA.localeCompare(projectB);
            }
            return 0;
        }

        // Render individual Kanban column
        function renderKanbanColumn(contentId, countId, actionsList, status) {
            console.log(`Rendering column ${contentId} with ${actionsList.length} actions:`, actionsList);
            
            const content = document.getElementById(contentId);
            const count = document.getElementById(countId);
            
            if (!content) {
                console.error(`Element with id ${contentId} not found!`);
                return;
            }
            
            count.textContent = `${actionsList.length} task${actionsList.length !== 1 ? 's' : ''}`;

            if (actionsList.length === 0) {
                content.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No tasks</div>';
                return;
            }

            content.innerHTML = actionsList.map((action, index) => {
                const originalIndex = actions.findIndex(a => a.emailId === action.emailId && a.text === action.text);
                
                // Get translated content for the action
                const email = emails.find(e => e.id === action.emailId);
                const displayContent = email ? getEmailDisplayContent(email) : null;
                const translatedAction = displayContent ? 
                    displayContent.actions.find(a => a.text === action.text || (currentLanguage !== 'original' && a.responsible === action.responsible && a.dueDate === action.dueDate)) : 
                    null;
                
                const actionText = translatedAction ? translatedAction.text : action.text;
                const emailSubject = displayContent ? displayContent.subject : action.emailSubject;
                
                return `
                <div class="kanban-item priority-${action.priority}" 
                     draggable="true" 
                     data-action-index="${originalIndex}"
                     data-status="${status}">
                    <div class="kanban-task-text">${actionText}</div>
                    <div class="kanban-task-meta">
                        From: ${emailSubject}<br>
                        Due: ${action.dueDate || 'N/A'}
                    </div>
                    <div class="kanban-task-controls">
                        <input type="checkbox" class="kanban-checkbox" 
                               ${action.completed ? 'checked' : ''} 
                               onchange="toggleActionStatus(${originalIndex})">
                        <select class="kanban-priority" 
                                onchange="changePriority(${originalIndex}, this.value)">
                            <option value="high" ${action.priority === 'high' ? 'selected' : ''}>High</option>
                            <option value="medium" ${action.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="low" ${action.priority === 'low' ? 'selected' : ''}>Low</option>
                        </select>
                    </div>
                    <div class="kanban-comments">
                        <div class="kanban-comments-label">Notes:</div>
                        <textarea class="kanban-comments-textarea" 
                                  placeholder="Add notes about what needs to be done or what has been completed..."
                                  onchange="updateActionComments(${originalIndex}, this.value)"
                                  onblur="updateActionComments(${originalIndex}, this.value)">${action.comments || ''}</textarea>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Toggle action completion
        function toggleAction(index) {
            if (actions[index]) { // Ensure action exists
                actions[index].completed = !actions[index].completed;
                localStorage.setItem('emails', JSON.stringify(emails)); // Save changes
                renderActions();
                updateStats(); // Update stats after action change
                // Refresh other tabs to show updated completion status
                renderEmails(); // Refresh Dashboard
                loadTimeline(); // Refresh Timeline
            }
        }

        // Change action priority
        function changePriority(index, newPriority) {
            if (actions[index]) { // Ensure action exists
                actions[index].priority = newPriority;
                localStorage.setItem('emails', JSON.stringify(emails)); // Save changes
                renderActions();
            }
        }

        // Update action comments
        function updateActionComments(index, comments) {
            if (actions[index]) { // Ensure action exists
                actions[index].comments = comments;
                localStorage.setItem('emails', JSON.stringify(emails)); // Save changes
                // No need to re-render for comments, just save
            }
        }

        // Helper function to check if an action is completed based on current Kanban status
        function isActionCompleted(actionText, responsible, dueDate, emailId) {
            // Find the action in the global actions array by matching key properties
            // First try exact text match
            let matchingAction = actions.find(action => 
                action.text === actionText && 
                action.responsible === responsible && 
                action.dueDate === dueDate &&
                action.emailId === emailId
            );
            
            // If no exact match found, try matching by responsible, dueDate, and emailId only
            // (in case the text is translated but the action properties are the same)
            if (!matchingAction) {
                const candidateActions = actions.filter(action => 
                    action.responsible === responsible && 
                    action.dueDate === dueDate &&
                    action.emailId === emailId
                );
                
                // If there's only one candidate, it's likely the same action with different text (translation)
                if (candidateActions.length === 1) {
                    matchingAction = candidateActions[0];
                }
            }
            
            // Debug logging
            if (!matchingAction) {
                console.log('No matching action found for:', {
                    actionText,
                    responsible,
                    dueDate,
                    emailId,
                    availableActions: actions.filter(a => a.emailId === emailId)
                });
            } else {
                console.log('Found matching action:', matchingAction, 'Completed:', matchingAction.status === 'completed' || matchingAction.completed);
            }
            
            return matchingAction && (matchingAction.status === 'completed' || matchingAction.completed);
        }

        // Sort actions (triggered by sort dropdown change)
        function sortActions() {
            renderActions();
        }

        // Filter actions
        function filterActions() {
            renderActions(); // Re-render applies filters
        }

        // Update progress bar
        function updateProgress() {
            const myActions = actions.filter(a => a.isMyAction);
            const completedCount = myActions.filter(action => action.completed).length;
            const totalCount = myActions.length;
            const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = 
                `${percentage}% complete (${completedCount} of ${totalCount} tasks)`;
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalEmails').textContent = emails.length;
            document.getElementById('activeProjects').textContent = projects.size;
            document.getElementById('pendingActions').textContent = actions.filter(a => !a.completed && a.isMyAction).length;
            document.getElementById('completedActions').textContent = actions.filter(a => a.completed && a.isMyAction).length;
        }

        // Filter emails (re-renders the grid with current filter selections)
        function filterEmails() {
            renderEmails();
        }

       // Load timeline for selected project
    function loadTimeline() {
        const selectedProject = document.getElementById('timelineProjectFilter').value;
        const container = document.getElementById('timelineContainer');

        if (!selectedProject) {
            container.innerHTML = '<p>Select a project to view its timeline</p>';
            return;
        }

        const projectEmails = emails.filter(email => email.project === selectedProject)
                                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort descending by date

        if (projectEmails.length === 0) {
            container.innerHTML = `<p>No emails found for project "${selectedProject}".</p>`;
            return;
        }

        // --- Generate General Project Summary ---
        let combinedSummaries = [];
        let projectActions = [];
        let projectSubjects = [];

        projectEmails.forEach(email => {
            const displayContent = getEmailDisplayContent(email);
            if (displayContent.summary) combinedSummaries.push(displayContent.summary);
            if (displayContent.subject) projectSubjects.push(displayContent.subject);
            (displayContent.actions || []).forEach(action => {
                projectActions.push({
                    ...action,
                    emailDate: email.date // Add email date to action for sorting
                });
            });
        });

        // a) What is the project about
        // Simple heuristic: Take the first few distinct sentences from summaries or relevant subjects.
        const projectAbout = combinedSummaries.length > 0 ? combinedSummaries.join(' ').substring(0, 300) + '...' : 'No detailed summary available.';
        const uniqueSubjects = [...new Set(projectSubjects)].slice(0, 5); // Take up to 5 unique subjects

        // b) Most important achievements / Key Discussion Points
        // Without explicit "achievements" in data, use key subjects/themes as a proxy for discussion points
        const achievementsHtml = uniqueSubjects.length > 0 ?
            `<ul>${uniqueSubjects.map(s => `<li>${s}</li>`).join('')}</ul>` :
            'No specific achievements identified yet (based on email subjects).';

        // c) Latest request/pending action
        const pendingActions = projectActions.filter(action => !action.completed && action.isMyAction)
                                             .sort((a, b) => new Date(b.dueDate || b.emailDate) - new Date(a.dueDate || a.emailDate));
        const latestPendingAction = pendingActions.length > 0 ? 
            `${pendingActions[0].text} (Due: ${pendingActions[0].dueDate || 'N/A'}, Responsible: ${pendingActions[0].responsible})` :
            'No pending actions currently identified for this project.';

        let projectSummaryHtml = `
            <div class="project-overall-summary">
                <h3>Overall Project Summary: ${selectedProject}</h3>
                <p><strong>What is the project about:</strong> ${projectAbout}</p>
                <p><strong>Key Discussion Points/Milestones:</strong></p>
                ${achievementsHtml}
                <p><strong>Latest Request/Pending Action:</strong> ${latestPendingAction}</p>
            </div>
        `;
        // --- End General Project Summary ---


        container.innerHTML = projectSummaryHtml + projectEmails.map(email => {
            const displayContent = getEmailDisplayContent(email);
            return `
            <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-date-time">
                        ${email.date ? new Date(email.date).toLocaleString() : 'Date N/A'}
                    </div>
                    <div class="timeline-cols">
                        <div class="timeline-col-left">
                            <strong>From:</strong> ${email.sender}<br>
                            <p>${displayContent.summary}</p>
                        </div>
                        <div class="timeline-col-right">
                            ${displayContent.actions && displayContent.actions.length > 0 ? `
                                <strong>Actions Generated:</strong>
                                <ul class="timeline-actions-list">
                                    ${displayContent.actions.map(action => {
                                        const isCompleted = isActionCompleted(action.text, action.responsible, action.dueDate, email.id);
                                        return `
                                        <li class="${isCompleted ? 'completed' : ''}">
                                            ${action.text} 
                                            <br><small>(Responsible: ${action.responsible || 'N/A'}, Due: ${action.dueDate || 'N/A'}, Priority: <span class="priority-${action.priority}">${action.priority || 'medium'}</span>)</small>
                                        </li>
                                        `;
                                    }).join('')}
                                </ul>
                            ` : 'No specific actions generated.'}
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.remove('hidden');

            // Add active class to clicked tab
            // event.target might not always be the button, so let's be safer
            document.querySelector(`.tabs button[onclick="showTab('${tabName}')"]`).classList.add('active');

            // Re-render relevant content when switching tabs to apply filters/sorts
            if (tabName === 'dashboard') renderEmails();
            else if (tabName === 'timeline') loadTimeline();
            else if (tabName === 'actions') renderActions();
            else if (tabName === 'attachments') renderAttachments();
        }

        // Render attachments table
        function renderAttachments() {
            const tbody = document.getElementById('attachmentsTableBody');
            
            // Apply current filters
            const fileTypeFilter = document.getElementById('fileTypeFilter')?.value || '';
            const attachmentProjectFilter = document.getElementById('attachmentProjectFilter')?.value || '';

            const filteredAttachments = attachments.filter(attachment => {
                const matchesFileType = !fileTypeFilter || 
                                        (fileTypeFilter === 'pdf' && attachment.name.toLowerCase().endsWith('.pdf')) ||
                                        (fileTypeFilter === 'doc' && (attachment.name.toLowerCase().endsWith('.doc') || attachment.name.toLowerCase().endsWith('.docx'))) ||
                                        (fileTypeFilter === 'xls' && (attachment.name.toLowerCase().endsWith('.xls') || attachment.name.toLowerCase().endsWith('.xlsx'))) ||
                                        (fileTypeFilter === 'img' && (attachment.name.toLowerCase().endsWith('.jpg') || attachment.name.toLowerCase().endsWith('.jpeg') || attachment.name.toLowerCase().endsWith('.png') || attachment.name.toLowerCase().endsWith('.gif')));
                const matchesProject = !attachmentProjectFilter || attachment.project === attachmentProjectFilter;
                return matchesFileType && matchesProject;
            });


            if (filteredAttachments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No attachments found matching filters.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredAttachments.map(attachment => {
                const fileExt = attachment.name.split('.').pop().toLowerCase();
                let fileIcon = '';
                
                if (['pdf'].includes(fileExt)) fileIcon = '';
                else if (['doc', 'docx'].includes(fileExt)) fileIcon = '';
                else if (['xls', 'xlsx'].includes(fileExt)) fileIcon = '';
                else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) fileIcon = '';
                else if (['zip', 'rar'].includes(fileExt)) fileIcon = '';

                return `
                    <tr>
                        <td>
                            <span class="file-icon">${fileIcon}</span>
                            <span class="attachment-name">${attachment.name}</span>
                        </td>
                        <td>${attachment.project}</td>
                        <td>${attachment.emailSubject}</td>
                        <td>${attachment.date}</td>
                        <td>
                            <a href="#" class="attachment-link" onclick="downloadAttachment('${attachment.name}')">
                                Download
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Download attachment (placeholder)
        function downloadAttachment(filename) {
            // Using a custom modal instead of alert()
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
                z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;">
                    <p style="font-size: 1.1em; margin-bottom: 20px;">Downloading ${filename}... (This is a placeholder action)</p>
                    <button onclick="this.parentNode.parentNode.remove()" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
            // In a real application, this would involve sending the attachment content.
            // For .msg attachments, you'd need the original blob to re-create the file.
        }

        // Project tag editing functions
        function editProjectTag(emailId) {
            // Close any other open editors
            document.querySelectorAll('.project-editor').forEach(editor => {
                editor.classList.remove('active');
            });
            
            const editor = document.getElementById(`editor-${emailId}`);
            editor.classList.add('active');
            
            // Focus on input
            const input = document.getElementById(`input-${emailId}`);
            if (input) { // Check if input exists
                input.focus();
                input.select();
            }
        }

        function saveProjectTag(emailId) {
            const input = document.getElementById(`input-${emailId}`);
            const newProject = input.value.trim();
            
            if (newProject) {
                // Find and update the email
                const email = emails.find(e => e.id === emailId);
                if (email) {
                    const oldProject = email.project; // Keep old project for potential cleanup
                    email.project = newProject;
                    
                    // Update projects set
                    projects.add(newProject);
                    // No need to remove oldProject from `projects` Set immediately, as other emails might still use it.
                    // The Set naturally cleans up if no other emails use an old project after all updates.
                    
                    // Update attachments associated with this email
                    attachments.forEach(att => {
                        if (att.emailId === emailId) {
                            att.project = newProject;
                        }
                    });

                    // Update actions associated with this email (if project is part of action data)
                    actions.forEach(action => {
                        if (action.emailId === emailId) {
                            // If action objects store project, update it here. Currently, they don't directly.
                            // The project is displayed in action meta, which relies on `emails` array.
                        }
                    });
                    
                    // Save to local storage after modification
                    localStorage.setItem('emails', JSON.stringify(emails));

                    // Re-render and update filters/stats
                    populateFilters();
                    renderEmails();
                    renderAttachments();
                    updateStats();
                }
            }
            
            cancelProjectEdit(emailId);
        }

        function cancelProjectEdit(emailId) {
            const editor = document.getElementById(`editor-${emailId}`);
            editor.classList.remove('active');
        }

        // Close project editors when clicking outside
        document.addEventListener('click', function(event) {
            // Check if the click was outside of any project-tag (and its editor)
            const clickedTag = event.target.closest('.project-tag');
            document.querySelectorAll('.project-editor.active').forEach(editor => {
                const emailId = editor.id.replace('editor-', '');
                const correspondingTag = document.querySelector(`.project-tag[data-email-id="${emailId}"]`);
                
                if (!clickedTag || !correspondingTag || !correspondingTag.contains(clickedTag)) {
                    // If clicked outside the current active editor's tag
                    editor.classList.remove('active');
                }
            });
        });


// --- DEEPSEEK Email Analysis Function ---

async function analyzeEmail(email, current, total) {
    // This is a mock function. Replace with your actual OpenAI API call.
    // It simulates the delay and response of an API call.
    
    updateLoader(`AI analyzing email ${current}/${total}...`, email.subject);

    // MOCK: Simulate API call delay
    await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));

    const prompt = `
You are an AI assistant for an email organizer. Analyze the following email content.
Extract the following information and return it as a JSON object.
Ensure the JSON is perfectly valid and can be parsed directly.

1.  Summary: A concise 2-3 sentence summary of the email's main topic and purpose.
2.  Actions: An array of actionable items for anyone (including the recipient of this email, me). Each action should have:
    - text: A clear, actionable description (e.g., "Schedule follow-up meeting").
    - responsible: The name or role of the person responsible (e.g., "John Doe", "Marketing Team", "me"). If it's ambiguous, assume "me" if it sounds like a task for the email recipient.
    - dueDate: A suggested due date in 'YYYY-MM-DD' format if implied (e.g., "next week" -> "2025-06-12"), otherwise an empty string. Consider current date: ${new Date().toISOString().split('T')[0]}.
    - priority: Assign 'high', 'medium', or 'low' based on urgency/importance.
3.  Project: A single, brief string identifying the main project, topic, or department the email belongs to (e.g., "Project Alpha", "HR", "Customer Support", "Sales"). Default to "Unclassified" if no clear project.

Email data:
Subject: ${email.subject}
From: ${email.sender}
Date: ${email.date}
Body: ${email.body || "No body content available."}

Example expected JSON format:
{
  "summary": "Meeting minutes for the Q3 planning session, outlining key decisions and next steps.",
  "actions": [
    {"text": "Finalize Q3 budget proposal", "responsible": "me", "dueDate": "2025-06-15", "priority": "high"},
    {"text": "Send out meeting recap to all attendees", "responsible": "John Doe", "dueDate": "2025-06-07", "priority": "medium"}
  ],
  "project": "Q3 Planning"
}
`;

    try {
   const response = await fetch("https://outlook-summarizer.onrender.com/api/deepseek", {
    method: "POST",
    headers: {
        "Content-Type": "application/json"
    },
    body: JSON.stringify({
        model: "deepseek-chat",
        messages: [
            { role: "system", content: "You are an email analysis assistant." },
            { role: "user", content: prompt }
        ],
        temperature: 0.2,
        max_tokens: 512
    })
});



        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
        }

        const result = await response.json();

        // Get the AI's response string
        let aiContent = result.choices?.[0]?.message?.content || "";
        let aiResult;
        try {
            let jsonString = result.choices[0].message.content.trim();
            // Remove leading and trailing markdown code block fences if present
            if (jsonString.startsWith('```json')) {
                jsonString = jsonString.substring(jsonString.indexOf('\n') + 1); // Get content after ```json
            }
            if (jsonString.endsWith('```')) {
                jsonString = jsonString.substring(0, jsonString.lastIndexOf('```')); // Get content before ```
            }
            aiResult = JSON.parse(jsonString);
        } catch (e) {
            console.error("Failed to parse AI response as JSON:", e, result.choices[0].message.content);
            email.summary = "AI response was not valid JSON. Please try again.";
            email.project = "Unclassified";
            email.actions = [];
            return;
        }

        // Assign results to the email object
        email.summary = aiResult.summary || "No summary from AI.";
        email.actions = (aiResult.actions || []).map(a => ({
            text: a.text || "Unnamed action",
            responsible: a.responsible || "Unknown",
            dueDate: a.dueDate || "",
            isMyAction: (a.responsible || "").toLowerCase().includes("me") || (a.responsible || "").toLowerCase().includes("you"),
            priority: (a.priority && ['high', 'medium', 'low'].includes(a.priority.toLowerCase())) ? a.priority.toLowerCase() : "medium"
        }));
        email.project = aiResult.project || "Unclassified";

    } catch (err) {
        console.error("AI request failed:", err);
        email.summary = "AI request failed due to network or API issue.";
        email.project = "Unclassified";
        email.actions = [];
    }
}

// Event listener for email file input
document.addEventListener('DOMContentLoaded', function() {
    const emailFileInput = document.getElementById('emailFileInput');
    if (emailFileInput) {
        emailFileInput.addEventListener('change', async function(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const totalFiles = files.length;
            showLoader(`Importing ${totalFiles} email(s)...`);

            let processedCount = 0;

            for (const file of files) {
                try {
                    updateLoader(`Extracting data from email ${processedCount + 1}/${totalFiles}...`, file.name);
                    
                    const arrayBuffer = await file.arrayBuffer();
                    if (typeof MSGReader === 'undefined') {
                        throw new Error("MSGReader library is not loaded. The portable HTML file may be corrupted.");
                    }
                    const msgReader = new MSGReader(arrayBuffer);
                    const msg = msgReader.getFileData();

                    const newEmail = {
                        id: Date.now() + Math.floor(Math.random() * 10000), // simple unique ID
                        subject: msg.subject || "(No subject)",
                        sender: msg.senderEmail || msg.senderName || "Unknown",
                        date: (() => {
                	let rawDateString = msg.messageDeliveryTime || "";
                	if (!rawDateString && msg.headers) {
                   	 // Look for 'Date:' header followed by whitespace and capture the rest of the line
                    	const dateHeaderMatch = msg.headers.match(/^Date:\s*(.*)$/m);
                    	if (dateHeaderMatch && dateHeaderMatch[1]) {
                        rawDateString = dateHeaderMatch[1].trim();
                    	      }
                	   }
                	   return rawDateString;
            		})(),
                        project: "",      // will be filled by AI
                        summary: "",      // will be filled by AI
                        actions: [],      // will be filled by AI
                        attachments: (msg.attachments || []).map(att => att.fileName), // Store only names for now
                        body: (msg.body || msg.bodyHTML || "") // Add body for AI analysis
                    };

                    emails.push(newEmail); // Add to emails list immediately

                    // Call AI analysis for each email, passing progress info
                    await analyzeEmail(newEmail, processedCount + 1, totalFiles);

                    // After AI analysis, update global lists
                    projects.add(newEmail.project); // Add AI-classified project
                    senders.add(newEmail.sender); // Add sender from email (or AI if classified differently)

                    // Collect attachments
                    (newEmail.attachments || []).forEach(attachmentName => {
                        attachments.push({
                            name: attachmentName,
                            project: newEmail.project, // Use AI-classified project
                            emailSubject: newEmail.subject,
                            date: newEmail.date,
                            emailId: newEmail.id
                        });
                    });

                    // Collect actions (that are for "me")
                    newEmail.actions.forEach(action => {
                        if (action.isMyAction) {
                            actions.push({
                                ...action,
                                emailId: newEmail.id,
                                emailSubject: newEmail.subject,
                                completed: false, // Default to not completed
                                priority: action.priority // Use AI-assigned priority
                            });
                        }
                    });

                    processedCount++;

                } catch (e) {
                    console.error(`Error processing file ${file.name}:`, e);
                    // Provide a user-friendly message for this specific file
                    const errorEmail = {
                        id: Date.now() + Math.floor(Math.random() * 10000),
                        subject: `Error processing: ${file.name}`,
                        sender: "System",
                        date: new Date().toISOString().split('T')[0],
                        project: "Error",
                        summary: `Could not process this email due to an error: ${e.message}`,
                        actions: [],
                        attachments: []
                    };
                    emails.push(errorEmail);
                    processedCount++; // Still increment to not get stuck
                }
            }

            updateLoader("Finalizing...", "Updating dashboard and saving data.");
            // Refresh UI/filters/statistics after all emails are imported and analyzed
            populateFilters();
            renderEmails();
            renderActions();
            renderAttachments();
            updateStats();
            // Save to local storage for persistence across sessions
            localStorage.setItem('emails', JSON.stringify(emails));

            hideLoader();
        });
    } else {
        console.error("emailFileInput element not found.");
    }
});

// Filter Modal Functions
function openFilterModal() {
    document.getElementById('filterModal').style.display = 'block';
    renderFilterRules();
}

function closeFilterModal() {
    document.getElementById('filterModal').style.display = 'none';
}

function addFilterRule() {
    const input = document.getElementById('newFilterInput');
    const rule = input.value.trim();
    
    if (rule) {
        const filters = JSON.parse(localStorage.getItem('emailFilters') || '[]');
        filters.push(rule);
        localStorage.setItem('emailFilters', JSON.stringify(filters));
        input.value = '';
        renderFilterRules();
        updateFilterStats();
    }
}

function deleteFilterRule(index) {
    const filters = JSON.parse(localStorage.getItem('emailFilters') || '[]');
    filters.splice(index, 1);
    localStorage.setItem('emailFilters', JSON.stringify(filters));
    renderFilterRules();
    updateFilterStats();
}

function editFilterRule(index) {
    const filters = JSON.parse(localStorage.getItem('emailFilters') || '[]');
    const rule = filters[index];
    const input = document.getElementById('newFilterInput');
    input.value = rule;
    deleteFilterRule(index);
}

function renderFilterRules() {
    const filters = JSON.parse(localStorage.getItem('emailFilters') || '[]');
    const container = document.getElementById('filterRulesList');
    
    if (filters.length === 0) {
        container.innerHTML = '<div class="no-filters-message">No filter rules added yet</div>';
        return;
    }

    container.innerHTML = filters.map((rule, index) => `
        <div class="filter-item">
            <div class="filter-text">${rule}</div>
            <div class="filter-actions">
                <button class="edit-filter-btn" onclick="editFilterRule(${index})">Edit</button>
                <button class="delete-filter-btn" onclick="deleteFilterRule(${index})">Delete</button>
            </div>
        </div>
    `).join('');
}

function updateFilterStats() {
    const filters = JSON.parse(localStorage.getItem('emailFilters') || '[]');
    const stats = document.getElementById('filterStats');
    stats.textContent = `${filters.length} filter rule${filters.length !== 1 ? 's' : ''} active`;
}

        // Initialize language toggle
        function initializeLanguageToggle() {
            const langSwitch = document.getElementById('langSwitch');
            const savedLanguage = localStorage.getItem('contentLanguage') || 'original';
            
            // Set initial state
            currentLanguage = savedLanguage;
            if (savedLanguage === 'es') {
                langSwitch.checked = true;
            }
            
            // Handle toggle change
            langSwitch.addEventListener('change', function() {
                if (this.checked) {
                    currentLanguage = 'es';
                } else {
                    currentLanguage = 'en';
                }
                
                localStorage.setItem('contentLanguage', currentLanguage);
                translateAndRenderAll();
            });
        }

        // Google Translate API function
        async function translateText(text, targetLang) {
            if (!text || text.trim() === '') return text;
            
            try {
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`);
                const data = await response.json();
                
                if (data && data[0] && data[0][0] && data[0][0][0]) {
                    return data[0][0][0];
                }
                return text; // Return original if translation fails
            } catch (error) {
                console.warn('Translation failed:', error);
                return text; // Return original if translation fails
            }
        }

        // Translate email content
        async function translateEmail(email, targetLang) {
            if (!email.translations) {
                email.translations = {};
            }
            
            // Check if translation already exists
            if (email.translations[targetLang]) {
                return email.translations[targetLang];
            }
            
            // Translate subject, summary, and actions
            const translatedSubject = await translateText(email.subject, targetLang);
            const translatedSummary = await translateText(email.summary, targetLang);
            
            const translatedActions = await Promise.all(
                email.actions.map(async (action) => ({
                    ...action,
                    text: await translateText(action.text, targetLang)
                }))
            );
            
            // Store translation
            email.translations[targetLang] = {
                subject: translatedSubject,
                summary: translatedSummary,
                actions: translatedActions
            };
            
            // Save to localStorage
            localStorage.setItem('emails', JSON.stringify(emails));
            
            return email.translations[targetLang];
        }

        // Translate and render emails
        async function translateAndRenderEmails() {
            if (currentLanguage === 'original') {
                renderEmails();
                return;
            }
            
            // Show loading indicator
            const grid = document.getElementById('emailGrid');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Translating content...';
            grid.appendChild(loadingDiv);
            
            // Translate all emails
            for (let email of emails) {
                await translateEmail(email, currentLanguage);
            }
            
            // Remove loading indicator and render
            if (loadingDiv.parentNode) {
                loadingDiv.parentNode.removeChild(loadingDiv);
            }
            renderEmails();
        }

        // Translate and render all content (emails, actions, timeline)
        async function translateAndRenderAll() {
            if (currentLanguage === 'original') {
                renderEmails();
                renderActions();
                loadTimeline();
                return;
            }
            
            // Show loading indicator
            const grid = document.getElementById('emailGrid');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Translating content...';
            grid.appendChild(loadingDiv);
            
            // Translate all emails
            for (let email of emails) {
                await translateEmail(email, currentLanguage);
            }
            
            // Remove loading indicator and render all sections
            if (loadingDiv.parentNode) {
                loadingDiv.parentNode.removeChild(loadingDiv);
            }
            
            // Re-render all sections with translated content
            renderEmails();
            renderActions();
            loadTimeline();
        }

        // Get display content for email based on current language
        function getEmailDisplayContent(email) {
            if (currentLanguage === 'original' || !email.translations || !email.translations[currentLanguage]) {
                return {
                    subject: email.subject,
                    summary: email.summary,
                    actions: email.actions
                };
            }
            
            return email.translations[currentLanguage];
        }

        // Initialize Kanban drag and drop
        function initializeKanbanDragDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
            });

            function handleDragOver(e) {
                e.preventDefault();
            }

            function handleDragEnter(e) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            }

            function handleDragLeave(e) {
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    e.currentTarget.classList.remove('drag-over');
                }
            }

            function handleDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                
                const actionIndex = e.dataTransfer.getData('text/plain');
                const targetColumn = e.currentTarget.id;
                
                let newStatus;
                if (targetColumn === 'pendingColumn') newStatus = 'pending';
                else if (targetColumn === 'progressColumn') newStatus = 'progress';
                else if (targetColumn === 'completedColumn') newStatus = 'completed';
                
                if (newStatus && actionIndex !== '') {
                    moveActionToStatus(parseInt(actionIndex), newStatus);
                }
            }

            // Add drag start event to items (will be called after rendering)
            setTimeout(() => {
                const items = document.querySelectorAll('.kanban-item');
                items.forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                });
            }, 100);

            function handleDragStart(e) {
                e.currentTarget.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.currentTarget.dataset.actionIndex);
            }

            function handleDragEnd(e) {
                e.currentTarget.classList.remove('dragging');
            }
        }

        // Move action to new status
        function moveActionToStatus(actionIndex, newStatus) {
            if (actions[actionIndex]) {
                actions[actionIndex].status = newStatus;
                
                if (newStatus === 'completed') {
                    actions[actionIndex].completed = true;
                    actions[actionIndex].completedDate = new Date().toISOString();
                } else {
                    actions[actionIndex].completed = false;
                    actions[actionIndex].completedDate = null;
                }
                
                localStorage.setItem('emails', JSON.stringify(emails));
                renderActions();
                updateStats();
                // Refresh other tabs to show updated completion status
                renderEmails(); // Refresh Dashboard
                loadTimeline(); // Refresh Timeline
            }
        }

        // Toggle action status (checkbox click)
        function toggleActionStatus(index) {
            if (actions[index]) {
                const currentStatus = actions[index].status;
                let newStatus;
                
                if (currentStatus === 'pending') {
                    newStatus = 'progress';
                } else if (currentStatus === 'progress') {
                    newStatus = 'completed';
                } else if (currentStatus === 'completed') {
                    newStatus = 'pending';
                }
                
                moveActionToStatus(index, newStatus);
            }
        }

        // Toggle action completion (legacy function - now redirects to toggleActionStatus)
        function toggleAction(index) {
            toggleActionStatus(index);
        }
    </script>
</body>
</html>
